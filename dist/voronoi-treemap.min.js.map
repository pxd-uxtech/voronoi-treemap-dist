{"version":3,"file":"voronoi-treemap.min.js","sources":["../src/utils/d3-bundle.js","../src/PebbleRenderer.js","../src/LabelAdjuster.js","../src/nestingForVoronoi.js","../src/VoronoiTreemapHelpers.js","../src/PopupHelpers.js","../src/VoronoiTreemap.js","../src/utils/showVoronoiPopup.js"],"sourcesContent":["/**\n * D3 Bundle Utility\n *\n * This module aggregates D3 core with voronoi extension libraries:\n * - d3 (core D3 library)\n * - d3-weighted-voronoi\n * - d3-voronoi-map\n * - d3-voronoi-treemap\n * - seedrandom\n *\n * The bundled d3 object is used throughout the library to ensure\n * all voronoi treemap methods are available on a single namespace.\n *\n * Original Observable require pattern:\n *   require(\"d3\", \"d3-weighted-voronoi\", \"d3-voronoi-map\", \"d3-voronoi-treemap\", \"seedrandom@2.4.3/seedrandom.min.js\")\n */\n\nimport * as d3Core from 'd3';\nimport * as d3WeightedVoronoi from 'd3-weighted-voronoi';\nimport * as d3VoronoiMap from 'd3-voronoi-map';\nimport * as d3VoronoiTreemap from 'd3-voronoi-treemap';\nimport * as seedrandomModule from 'seedrandom';\n\n/**\n * Merged D3 namespace with all voronoi treemap extensions\n * This replicates the Observable require behavior:\n *   require(\"d3\", \"d3-weighted-voronoi\", \"d3-voronoi-map\", \"d3-voronoi-treemap\", \"seedrandom\")\n * which merges all modules into a single namespace.\n */\nconst d3 = Object.assign(\n  {},\n  d3Core,\n  d3WeightedVoronoi,\n  d3VoronoiMap,\n  d3VoronoiTreemap\n);\n\n// Attach seedrandom for reproducible random number generation\n// This allows usage like: d3.seedrandom('myseed')\nd3.seedrandom = seedrandomModule.default || seedrandomModule;\n\nexport default d3;\n","/**\n * PebbleRenderer\n *\n * Renders smooth \"pebble-like\" outlines around voronoi treemap cells.\n * Creates rounded corner effects for depth-1 (region) and depth-2\n * (cluster) boundaries to give the treemap a polished, organic appearance.\n *\n * Features:\n * - Smooth path generation with configurable corner radius\n * - Color variation for depth-2 outlines\n * - Point simplification for cleaner paths\n */\n\nimport d3 from './utils/d3-bundle.js';\n\n/**\n * PebbleRenderer - Smooth outline renderer for voronoi treemaps\n *\n * This class provides methods to render smooth, rounded outlines\n * around voronoi treemap cells at different depth levels.\n */\nexport class PebbleRenderer {\n  /**\n   * Create a PebbleRenderer instance\n   * @param {Object} [d3Instance] - Optional D3 instance (defaults to global d3)\n   */\n  constructor(d3Instance) {\n    this.d3 = d3Instance || d3;\n  }\n\n  /**\n   * Render pebble-style outlines for a treemap SVG\n   * @param {SVGElement} treemap - The SVG element containing the treemap\n   * @param {number} [round=10] - Corner radius for smoothing\n   * @param {number} [width=3] - Stroke width for depth-1 outlines\n   * @param {Function} [colorVarFunc] - Optional color variation function\n   */\n  render(treemap, round = 10, width = 3, colorVarFunc) {\n    const container = this.d3.select(treemap);\n    const cell = container.select('g.cell');\n\n    if (cell.empty()) {\n      return;\n    }\n\n    const chartGroup = this.d3.select(cell.node().parentNode);\n\n    chartGroup.select('.cell-outline').remove();\n    chartGroup.select('.cell-outline2').remove();\n\n    const outlineGroup = chartGroup\n      .insert('g', 'g.cell + *')\n      .attr('class', 'cell-outline');\n\n    const outlineGroup2 = chartGroup\n      .insert('g', 'g.cell + *')\n      .attr('class', 'cell-outline')\n      .attr('id', 'outline2');\n\n    this._renderDepth2Outlines(cell, outlineGroup2, colorVarFunc);\n    this._renderDepth1Outlines(cell, outlineGroup, round, width);\n  }\n\n  /**\n   * Render outlines for depth-2 cells (cluster level)\n   * @param {Object} cell - D3 selection of cell group\n   * @param {Object} outlineGroup - D3 selection of outline group\n   * @param {Function} [colorVarFunc] - Optional color variation function\n   * @private\n   */\n  _renderDepth2Outlines(cell, outlineGroup, colorVarFunc) {\n    const self = this;\n\n    cell.selectAll('.regionArea2').each(function (datum) {\n      const path = self.d3.select(this);\n      const polygon = datum.polygon;\n\n      const cellColor = colorVarFunc\n        ? colorVarFunc(datum.parent.color, 0, -0.2, -0.15)\n        : self._defaultColorVar(datum.parent.color, 0, -0.2, -0.15);\n\n      path.style('stroke', cellColor);\n\n      if (polygon && polygon.length > 0) {\n        const originalPath =\n          'M' + polygon.map((p) => `${p[0]},${p[1]}`).join('L') + 'Z';\n        const smoothedPath = self.smoothPath(originalPath, 8, 2);\n\n        outlineGroup\n          .append('path')\n          .attr('d', `${originalPath} ${smoothedPath}`)\n          .attr('fill', cellColor)\n          .attr('stroke', cellColor)\n          .attr('stroke-width', 0)\n          .style('fill-rule', 'evenodd');\n      }\n    });\n  }\n\n  /**\n   * Render outlines for depth-1 cells (region level)\n   * @param {Object} cell - D3 selection of cell group\n   * @param {Object} outlineGroup - D3 selection of outline group\n   * @param {number} round - Corner radius for smoothing\n   * @param {number} width - Stroke width\n   * @private\n   */\n  _renderDepth1Outlines(cell, outlineGroup, round, width) {\n    const self = this;\n\n    cell.selectAll('.regionArea1').each(function (datum) {\n      const polygon = datum.polygon;\n\n      if (polygon && polygon.length > 0) {\n        const originalPath =\n          'M' + polygon.map((p) => `${p[0]},${p[1]}`).join('L') + 'Z';\n        const smoothedPath = self.smoothPath(originalPath, round);\n\n        outlineGroup\n          .append('path')\n          .attr('d', `${originalPath} ${smoothedPath}`)\n          .attr('fill', '#555')\n          .attr('stroke', '#555')\n          .attr('stroke-width', width)\n          .style('fill-rule', 'evenodd');\n      }\n    });\n  }\n\n  /**\n   * Generate a smoothed SVG path with rounded corners\n   * @param {string} pathData - Original SVG path data (M...L...Z format)\n   * @param {number} [cornerRadius=10] - Radius for corner rounding\n   * @param {number} [minDistanceThreshold=0] - Minimum distance between points\n   * @returns {string} Smoothed SVG path data\n   */\n  smoothPath(pathData, cornerRadius = 10, minDistanceThreshold = 0) {\n    const rawPoints = pathData\n      .replace(/[MZ]/gi, '')\n      .split('L')\n      .map((d) => d.trim().split(',').map(Number))\n      .filter(([x, y]) => !isNaN(x) && !isNaN(y));\n\n    if (rawPoints.length < 3) return pathData;\n\n    let simplifiedPoints = this._simplifyPoints(rawPoints, minDistanceThreshold);\n\n    if (simplifiedPoints.length < 3) return pathData;\n\n    const n = simplifiedPoints.length;\n    let newPath = '';\n\n    for (let i = 0; i < n; i++) {\n      const p0 = simplifiedPoints[(i - 1 + n) % n];\n      const p1 = simplifiedPoints[i];\n      const p2 = simplifiedPoints[(i + 1) % n];\n\n      const vIn = { x: p0[0] - p1[0], y: p0[1] - p1[1] };\n      const vOut = { x: p2[0] - p1[0], y: p2[1] - p1[1] };\n      const lenIn = Math.hypot(vIn.x, vIn.y);\n      const lenOut = Math.hypot(vOut.x, vOut.y);\n\n      if (lenIn < 1e-7 || lenOut < 1e-7) continue;\n\n      const inNorm = { x: vIn.x / lenIn, y: vIn.y / lenIn };\n      const outNorm = { x: vOut.x / lenOut, y: vOut.y / lenOut };\n\n      const dot = inNorm.x * outNorm.x + inNorm.y * outNorm.y;\n      let angle = Math.acos(Math.max(-1, Math.min(1, dot)));\n\n      const adjustedRadius =\n        angle < Math.PI / 4.5 ? cornerRadius / 2 : cornerRadius;\n      const halfAngle = angle / 2;\n      const maxRadiusByLength = Math.min(lenIn, lenOut) / 2.1;\n      const d = Math.min(\n        lenIn,\n        lenOut,\n        adjustedRadius / Math.tan(halfAngle),\n        maxRadiusByLength / Math.tan(halfAngle)\n      );\n\n      const pStart = [p1[0] + inNorm.x * d, p1[1] + inNorm.y * d];\n      const pEnd = [p1[0] + outNorm.x * d, p1[1] + outNorm.y * d];\n\n      newPath +=\n        i === 0\n          ? `M${pStart[0]},${pStart[1]}`\n          : ` L${pStart[0]},${pStart[1]}`;\n      newPath += ` Q${p1[0]},${p1[1]} ${pEnd[0]},${pEnd[1]}`;\n    }\n\n    newPath += 'Z';\n    return newPath;\n  }\n\n  /**\n   * Simplify polygon points by removing those too close together\n   * @param {Array} rawPoints - Array of [x, y] coordinate pairs\n   * @param {number} minDistanceThreshold - Minimum distance between points\n   * @returns {Array} Simplified array of points\n   * @private\n   */\n  _simplifyPoints(rawPoints, minDistanceThreshold) {\n    if (minDistanceThreshold <= 0 || rawPoints.length <= 3) {\n      return rawPoints;\n    }\n\n    const tempPoints = [rawPoints[0]];\n    let lastPoint = rawPoints[0];\n\n    for (let i = 1; i < rawPoints.length; i++) {\n      const currentPoint = rawPoints[i];\n      const dist = Math.hypot(\n        currentPoint[0] - lastPoint[0],\n        currentPoint[1] - lastPoint[1]\n      );\n\n      if (dist >= minDistanceThreshold) {\n        tempPoints.push(currentPoint);\n        lastPoint = currentPoint;\n      }\n    }\n\n    const firstPoint = tempPoints[0];\n    const lastAddedPoint = tempPoints[tempPoints.length - 1];\n    if (lastAddedPoint !== firstPoint) {\n      const dist = Math.hypot(\n        firstPoint[0] - lastAddedPoint[0],\n        firstPoint[1] - lastAddedPoint[1]\n      );\n      if (dist < minDistanceThreshold) {\n        tempPoints.pop();\n      }\n    }\n\n    return tempPoints.length >= 3 ? tempPoints : rawPoints;\n  }\n\n  /**\n   * Generate a color variation using HSL adjustments\n   * @param {string} color - Base color (any CSS color format)\n   * @param {number} [h=0] - Hue adjustment\n   * @param {number} [l=0] - Lightness adjustment\n   * @param {number} [s=0] - Saturation adjustment\n   * @returns {string} Adjusted color in hex format\n   * @private\n   */\n  _defaultColorVar(color, h = 0, l = 0, s = 0) {\n    let c = this.d3.hsl(color);\n    c.h += h;\n    c.l += l;\n    c.s += s;\n    if (c.l > 0.95) c.l = 0.95;\n    return c.formatHex();\n  }\n}\n\nexport default PebbleRenderer;\n","/**\n * LabelAdjuster\n *\n * Handles automatic label collision detection and position adjustment\n * for voronoi treemap visualizations. Adjusts label positions to prevent\n * overlapping between:\n * - Field labels and region labels\n * - Sector labels and field labels\n *\n * Uses setTimeout-based deferred processing to ensure DOM elements\n * are fully rendered before measuring and adjusting positions.\n */\n\nimport d3 from './utils/d3-bundle.js';\n\n/**\n * LabelAdjuster - Label collision detection and adjustment\n *\n * This class provides methods to automatically adjust label positions\n * in voronoi treemaps to prevent overlapping text elements.\n */\nexport class LabelAdjuster {\n  /**\n   * Create a LabelAdjuster instance\n   * @param {Object} [d3Instance] - Optional D3 instance (defaults to global d3)\n   */\n  constructor(d3Instance) {\n    this.d3 = d3Instance || d3;\n  }\n\n  /**\n   * Adjust label positions in a treemap SVG to prevent overlapping\n   * @param {SVGElement} treemap - The SVG element containing the treemap\n   * @param {Object} [options={}] - Adjustment options\n   * @param {number} [options.verticalSpacing=0] - Additional vertical spacing between labels\n   * @param {number} [options.delay=100] - Delay in ms before adjustment (for DOM rendering)\n   */\n  adjust(treemap, options = {}) {\n    const { verticalSpacing = 0, delay = 100 } = options;\n    const d3 = this.d3;\n\n    setTimeout(() => {\n      const svg = d3.select(treemap);\n\n      svg.selectAll(\".field\").each(function () {\n        adjustFieldLabel(d3.select(this));\n      });\n\n      svg.selectAll(\".sector\").each(function () {\n        adjustSectorLabel(d3.select(this));\n      });\n    }, delay);\n\n    /**\n     * Parse SVG transform attribute to extract x, y translation\n     * @param {string} transform - Transform attribute string\n     * @returns {Object} { x, y } translation values\n     */\n    function parseTransform(transform) {\n      if (!transform) return { x: 0, y: 0 };\n      const match = transform.match(/translate\\(([^,]+),([^)]+)\\)/);\n      if (!match) return { x: 0, y: 0 };\n      return { x: parseFloat(match[1]), y: parseFloat(match[2]) };\n    }\n\n    /**\n     * Check if two bounding boxes overlap\n     * @param {Object} box1 - First bounding box\n     * @param {Object} box2 - Second bounding box\n     * @returns {boolean} True if boxes overlap\n     */\n    function checkOverlap(box1, box2) {\n      const margin = verticalSpacing / 2;\n      const marginx = -3;\n      return !(\n        box1.x + box1.width / 2 + marginx < box2.x - box2.width / 2 ||\n        box1.x - box1.width / 2 - marginx > box2.x + box2.width / 2 ||\n        box1.y + box1.height / 2 + margin < box2.y - box2.height / 2 ||\n        box1.y - box1.height / 2 - margin > box2.y + box2.height / 2\n      );\n    }\n\n    /**\n     * Calculate required vertical move distance to resolve overlap\n     * @param {Object} box1 - First bounding box\n     * @param {Object} box2 - Second bounding box\n     * @returns {number} Required move distance\n     */\n    function getRequiredMoveDistance(box1, box2) {\n      const margin = verticalSpacing / 2;\n      const box1Top = box1.y - box1.height / 2 - margin;\n      const box1Bottom = box1.y + box1.height / 2 + margin;\n      const box2Top = box2.y - box2.height / 2 - margin;\n      const box2Bottom = box2.y + box2.height / 2 + margin;\n\n      if (box1Bottom <= box2Top || box1Top >= box2Bottom) return 0;\n      if (box1.y < box2.y) return box1Bottom - box2Top;\n      return box2Bottom - box1Top;\n    }\n\n    /**\n     * Get bounding box information for a label element\n     * @param {Object} element - D3 selection of label element\n     * @returns {Object|null} Bounding box info or null if element invalid\n     */\n    function getLabelBox(element) {\n      const node = element.node();\n      if (!node) return null;\n\n      const bbox = node.getBBox();\n      let { width, height } = bbox;\n      const tspanCount = element.selectAll(\"tspan tspan\").size() || 1;\n      const transform = parseTransform(element.attr(\"transform\"));\n\n      return {\n        originalX: transform.x,\n        originalY: transform.y,\n        x: transform.x + width / 2,\n        y: transform.y + height / 2,\n        width,\n        height,\n        tspanCount\n      };\n    }\n\n    /**\n     * Get cell polygon bounds from node data\n     * @param {Object} data - Node data with polygon\n     * @returns {Object|null} { minX, maxX, minY, maxY } or null\n     */\n    function getCellBounds(data) {\n      if (!data || !data.polygon) return null;\n      const xs = data.polygon.map((p) => p[0]);\n      const ys = data.polygon.map((p) => p[1]);\n      return {\n        minX: Math.min(...xs),\n        maxX: Math.max(...xs),\n        minY: Math.min(...ys),\n        maxY: Math.max(...ys)\n      };\n    }\n\n    /**\n     * Calculate minimum move position to avoid overlap\n     * @param {Object} labelBox - Label bounding box\n     * @param {Object} parentBox - Parent label bounding box\n     * @param {Object} cellBounds - Cell polygon bounds\n     * @returns {Object} { x, y } new position\n     */\n    function findMinimumMove(labelBox, parentBox, cellBounds) {\n      if (\n        labelBox.x + labelBox.width / 2 < parentBox.x - parentBox.width / 2 ||\n        labelBox.x - labelBox.width / 2 > parentBox.x + parentBox.width / 2\n      ) {\n        return { x: labelBox.originalX, y: labelBox.originalY };\n      }\n\n      const moveDistance = getRequiredMoveDistance(labelBox, parentBox);\n      if (moveDistance === 0) {\n        return { x: labelBox.originalX, y: labelBox.originalY };\n      }\n\n      const originallyAbove = labelBox.y < parentBox.y;\n      let newY = labelBox.y;\n\n      if (originallyAbove) {\n        const proposedY =\n          parentBox.originalY -\n          labelBox.height +\n          (labelBox.tspanCount > 1\n            ? labelBox.height / (labelBox.tspanCount - 1) / 4\n            : 0);\n        if (proposedY >= cellBounds.minY) newY = proposedY;\n      } else {\n        const proposedY =\n          parentBox.originalY +\n          parentBox.height +\n          (labelBox.tspanCount > 1\n            ? labelBox.height / (labelBox.tspanCount - 1) / 4\n            : 0);\n        if (proposedY + labelBox.height <= cellBounds.maxY) newY = proposedY;\n      }\n\n      return { x: labelBox.originalX, y: newY };\n    }\n\n    /**\n     * Adjust sector label position if overlapping with parent field label\n     * @param {Object} sectorLabel - D3 selection of sector label\n     */\n    function adjustSectorLabel(sectorLabel) {\n      const data = sectorLabel.datum();\n      if (!data || !data.parent) return;\n\n      const parentFieldElement = d3\n        .select(treemap)\n        .selectAll(\".field\")\n        .filter((d) => d?.data?.key === data.parent?.data?.key)\n        .nodes()[0];\n\n      if (!parentFieldElement) return;\n\n      const fieldLabel = d3.select(parentFieldElement);\n      const sectorBox = getLabelBox(sectorLabel);\n      const fieldBox = getLabelBox(fieldLabel);\n      const cellBounds = getCellBounds(data);\n\n      if (\n        !cellBounds ||\n        !sectorBox ||\n        !fieldBox ||\n        sectorBox.width === 0 ||\n        sectorBox.height === 0 ||\n        fieldBox.width === 0 ||\n        fieldBox.height === 0\n      ) {\n        return;\n      }\n\n      if (checkOverlap(sectorBox, fieldBox)) {\n        const newPos = findMinimumMove(sectorBox, fieldBox, cellBounds);\n        sectorLabel.attr(\"transform\", `translate(${newPos.x},${newPos.y})`);\n      }\n    }\n\n    /**\n     * Adjust field label position if overlapping with parent region label\n     * @param {Object} fieldLabel - D3 selection of field label\n     */\n    function adjustFieldLabel(fieldLabel) {\n      const data = fieldLabel.datum();\n      if (!data || !data.parent) return;\n\n      const parentRegionElement = d3\n        .select(treemap)\n        .selectAll(\".region\")\n        .filter((d) => d?.data?.key === data.parent?.data?.key)\n        .nodes()[0];\n\n      if (!parentRegionElement) return;\n\n      const regionLabel = d3.select(parentRegionElement);\n      const fieldBox = getLabelBox(fieldLabel);\n      const regionBox = getLabelBox(regionLabel);\n      const cellBounds = getCellBounds(data);\n\n      if (\n        !cellBounds ||\n        !fieldBox ||\n        !regionBox ||\n        fieldBox.width === 0 ||\n        fieldBox.height === 0 ||\n        regionBox.width === 0 ||\n        regionBox.height === 0\n      ) {\n        return;\n      }\n\n      const regionKey = regionLabel.datum()?.data?.key;\n      if (\n        regionKey &&\n        String(regionKey).match(/[^ ]/) &&\n        checkOverlap(fieldBox, regionBox)\n      ) {\n        const newPos = findMinimumMove(fieldBox, regionBox, cellBounds);\n        fieldLabel.attr(\"transform\", `translate(${newPos.x},${newPos.y})`);\n      }\n    }\n  }\n}\n\nexport default LabelAdjuster;\n","/**\n * Nesting For Voronoi Utility\n *\n * Transforms flat data into a nested hierarchical structure suitable\n * for d3.hierarchy() and voronoi treemap visualization.\n *\n * Creates a 3-level hierarchy: root -> region -> bigCluster -> cluster\n * Each leaf node contains size values for sizing and references to original data.\n */\n\nimport d3 from './utils/d3-bundle.js';\n\n/**\n * Convert flat data array into nested hierarchy structure for voronoi treemap\n *\n * @param {Object[]} data - Array of data objects with region, bigClusterLabel, clusterLabel, and bubbleSize fields\n * @param {string} [key1='bigClusterLabel'] - Field name for first level grouping (big cluster)\n * @param {string} [key2='clusterLabel'] - Field name for second level grouping (cluster)\n * @returns {Object} Nested hierarchy object with key/values structure for d3.hierarchy\n *\n * @example\n * const data = [\n *   { region: 'A', bigClusterLabel: 'Group1', clusterLabel: 'Item1', bubbleSize: 10 },\n *   { region: 'A', bigClusterLabel: 'Group1', clusterLabel: 'Item2', bubbleSize: 20 }\n * ];\n * const nested = nestingForVoronoi(data);\n * const hierarchy = d3.hierarchy(nested, d => d.values).sum(d => d.size);\n */\nexport function nestingForVoronoi(\n  data,\n  key1 = \"bigClusterLabel\",\n  key2 = \"clusterLabel\"\n) {\n  // 1. Extract only necessary fields\n  const simpleData = data.map((d) => ({\n    [key1]: d[key1],\n    [key2]: d[key2],\n    region: d.region,\n    size: d.bubbleSize ?? 1\n  }));\n\n  // 2. 3-level grouping with d3.rollups: region -> key1 -> key2\n  const nested = d3.rollups(\n    simpleData,\n    (d) => d3.sum(d.map((v) => v.size)),\n    (d) => d.region,\n    (d) => d[key1],\n    (d) => d[key2]\n  );\n\n  // 3. Helper to convert to dictionary format\n  const makeDictionary = (bc, bcData, region) => {\n    return bcData.map((k) => {\n      const item = {\n        [key1]: bc,\n        [key2]: k[0],\n        size: k[1] ? k[1] : 1\n      };\n\n      const originalData = data.filter(\n        (c) =>\n          c.region === region &&\n          c[key1] === item[key1] &&\n          c[key2] === item[key2]\n      );\n\n      return {\n        key: k[0],\n        values: [item],\n        data: originalData[0],\n        raw: originalData\n      };\n    });\n  };\n\n  // 4. Generate final hierarchical structure\n  const kv = nested.map(([region, regionData]) => ({\n    key: region,\n    values: regionData.map(([bc, bcData]) => ({\n      key: bc,\n      values: makeDictionary(bc, bcData, region)\n    }))\n  }));\n\n  return {\n    key: \"root_nest\",\n    values: kv.filter((d) => d.key)\n  };\n}\n\nexport default nestingForVoronoi;\n","/**\n * Voronoi Treemap Helpers\n *\n * Static utility methods for voronoi treemap visualization including:\n * - Font scaling functions for label sizing\n * - Color manipulation and hierarchy coloring\n * - Text layout and multiline label rendering\n * - Polygon bounds and position calculations\n * - Number formatting utilities\n * - Custom voronoi algorithm creation\n */\n\nimport d3 from './utils/d3-bundle.js';\n\n/**\n * VoronoiTreemapHelpers - Collection of static helper methods\n *\n * These methods support the main VoronoiTreemap class with calculations\n * for sizing, positioning, coloring, and layout of treemap cells and labels.\n */\nconst VoronoiTreemapHelpers = {\n  // === Font Scale Functions ===\n\n  /**\n   * Calculate font scale based on node value ratio in hierarchy\n   * @param {Object} hierarchy - D3 hierarchy root node\n   * @param {Object} d - Current node\n   * @returns {number} Font scale value (0.3 to 1.5)\n   */\n  fontScale: function (hierarchy, d) {\n    let ratio = (d.value / hierarchy.value) * 100;\n    if (ratio > 30) ratio = 30;\n    if (ratio < 0.2) ratio = 0.2;\n    return d3.scaleLog().domain([0.1, 20]).range([0.3, 1.5])(ratio);\n  },\n\n  /**\n   * Calculate font scale for a specific value (not node-based)\n   * @param {Object} hierarchy - D3 hierarchy root node\n   * @param {string} string - Text string (unused but kept for API compatibility)\n   * @param {number} value - Value to calculate scale for\n   * @returns {number} Font scale value (0.3 to 1.5)\n   */\n  fontScale1: function (hierarchy, string, value) {\n    let ratio = (value / hierarchy.value) * 100;\n    if (ratio > 30) ratio = 30;\n    if (ratio < 0.2) ratio = 0.2;\n    return d3.scaleLog().domain([0.1, 20]).range([0.3, 1.5])(ratio);\n  },\n\n  /**\n   * Calculate secondary font scale (smaller range for sub-labels)\n   * @param {Object} hierarchy - D3 hierarchy root node\n   * @param {Object} d - Current node\n   * @returns {number} Font scale value (0.5 to 0.8)\n   */\n  fontScale2: function (hierarchy, d) {\n    let ratio = (d.value / hierarchy.value) * 100;\n    if (ratio > 5) ratio = 5;\n    if (ratio < 0.1) ratio = 0.1;\n    return d3.scaleLog().domain([0.1, 8]).range([0.5, 0.8])(ratio);\n  },\n\n  /**\n   * Calculate variable font scale for label positioning\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @returns {number} Calculated offset value\n   */\n  varFontScale: function (self, d) {\n    const text = d.data.data.clusterLabel ?? d.data.data.bigClusterLabel;\n    const [cols, rows] = this.multiline(text, true);\n    return d.data.data.clusterLabel\n      ? (this.fontScale2(self.hierarchy, d) * 6 * rows) / 2 + 20\n      : (this.fontScale(self.hierarchy, d) * 30 * rows) / 2 + 8;\n  },\n\n  // === Color Functions ===\n\n  /**\n   * Get HSL color with adjustments\n   * @param {string} color - Base color\n   * @param {number} [h=0] - Hue adjustment\n   * @param {number} [s=0] - Saturation adjustment\n   * @param {number} [l=0] - Lightness adjustment\n   * @returns {string} Hex color string\n   */\n  getHSLColor: function (color, h, s, l) {\n    h = h || 0;\n    s = s || 0;\n    l = l || 0;\n    const hslColor = d3.hsl(color);\n    const lighterColor = hslColor.copy({\n      h: hslColor.h + h,\n      s: hslColor.s + s,\n      l: hslColor.l + l\n    });\n    return lighterColor.formatHex();\n  },\n\n  /**\n   * Color variation with HSL adjustments (alternate parameter order)\n   * @param {string} color - Base color\n   * @param {number} [h=0] - Hue adjustment\n   * @param {number} [l=0] - Lightness adjustment\n   * @param {number} [s=0] - Saturation adjustment\n   * @returns {string} Hex color string\n   */\n  colorVar: function (color, h, l, s) {\n    h = h || 0;\n    l = l || 0;\n    s = s || 0;\n    let c = d3.hsl(color);\n    c.h += h;\n    c.l += l;\n    c.s += s;\n    if (c.l > 0.95) c.l = 0.95;\n    return c.formatHex();\n  },\n\n  /**\n   * Color variation for secondary elements (darker, less saturated)\n   * @param {string} color - Base color\n   * @returns {string} Hex color string\n   */\n  colorVar2: function (color) {\n    let c = d3.hsl(color);\n    c.l = c.l * 0.3;\n    c.s = 0.25;\n    if (c.l > 0.95) c.l = 0.95;\n    if (c.l < 0.1) c.l = 0.1;\n    return c.formatHex();\n  },\n\n  /**\n   * Color variation based on value within domain\n   * @param {string} color - Base color\n   * @param {number[]} vdomain - Value domain array for extent calculation\n   * @param {number} value - Current value\n   * @param {string} desc - Description (unused but kept for API compatibility)\n   * @returns {string} Hex color string\n   */\n  colorvariation: function (color, vdomain, value, desc) {\n    const domain = d3.extent(vdomain);\n    let vScale = d3.scaleLinear().domain(domain).range([0.3, 1]);\n    let c = d3.hsl(color);\n    if (c.l > 0.8) c.l = 0.8;\n    c.l += (0.5 - vScale(value)) * 0.1;\n    if (c.l > 0.9) c.l = 0.9;\n    return c.formatHex();\n  },\n\n  /**\n   * Recursively assign colors to hierarchy nodes based on depth\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} hierarchy - D3 hierarchy node to color\n   */\n  colorHierarchy: function (self, hierarchy) {\n    if (hierarchy.depth === 0) {\n      hierarchy.color = \"#ddd\";\n    } else if (hierarchy.depth === 1) {\n      hierarchy.color = self.regionColor(hierarchy.data.key);\n    } else if (hierarchy.depth === 2) {\n      hierarchy.color = this.colorvariation(\n        hierarchy.parent.color,\n        hierarchy.parent.children.map((d) => d.value),\n        hierarchy.value,\n        hierarchy.depth + hierarchy.data.key\n      );\n    } else if (hierarchy.depth === 3) {\n      hierarchy.color = this.colorvariation(\n        hierarchy.parent.color,\n        hierarchy.parent.parent.children.map((d) => d.value),\n        hierarchy.value,\n        hierarchy.depth + hierarchy.data.key\n      );\n      if (self.params.colorFunc) {\n        const originalData = self.data.filter(\n          (d) =>\n            d.clusterLabel === hierarchy.data.key &&\n            d.bigClusterLabel === hierarchy.parent.data.key\n        );\n        hierarchy.color = self.params.colorFunc(\n          originalData,\n          hierarchy.data.data,\n          hierarchy.color,\n          {\n            parentColor: hierarchy.parent.color,\n            siblings: hierarchy.parent.parent.children.map((d) => d.value),\n            value: hierarchy.value,\n            depth: hierarchy.depth,\n            region: hierarchy.parent.parent\n          }\n        );\n      }\n    }\n    if (hierarchy.children) {\n      hierarchy.children.forEach((child) => this.colorHierarchy(self, child));\n    }\n  },\n\n  // === Text & Label Functions ===\n\n  /**\n   * Convert text to multiline SVG tspan format\n   * @param {string} text - Input text\n   * @param {boolean} [getBoxInfo=false] - If true, return [maxWidth, lineCount] instead of HTML\n   * @returns {string|number[]} HTML string for tspans, or [maxWidth, lineCount] if getBoxInfo is true\n   */\n  multiline: function (text, getBoxInfo) {\n    const inputText = text ? String(text) : \"\";\n    const isLatinText = !/[^A-Za-z0-9\\s\\-.,!?:;@]/.test(inputText);\n    const forcedLineBreaks = inputText.split(\"\\n\");\n    let allLines = [];\n\n    forcedLineBreaks.forEach((line) => {\n      const words = line.split(/[ ,]/);\n      let currentLines = [];\n      let count = 0;\n      let lineCount = 0;\n      currentLines[0] = \"\";\n\n      words.forEach((word) => {\n        if (word.length + count > (isLatinText ? 9 : 7)) {\n          lineCount += 1;\n          count = 0;\n          currentLines[lineCount] = \"\";\n        }\n        currentLines[lineCount] = currentLines[lineCount] + word.trim() + \" \";\n        count += word.length;\n      });\n      const filteredLines = currentLines.filter((d) => d.trim());\n      allLines = allLines.concat(filteredLines);\n    });\n\n    const charWidths = {\n      i: 0.4,\n      j: 0.4,\n      l: 0.4,\n      t: 0.5,\n      f: 0.5,\n      r: 0.6,\n      I: 0.3,\n      1: 0.6,\n      \"!\": 0.3,\n      \"|\": 0.3,\n      \".\": 0.3,\n      \",\": 0.3,\n      \":\": 0.3,\n      \";\": 0.4,\n      w: 1.4,\n      W: 1.6,\n      m: 1.3,\n      M: 1.5,\n      \"@\": 1.4,\n      a: 0.9,\n      e: 0.9,\n      o: 0.9,\n      u: 0.9,\n      n: 0.9,\n      s: 0.8,\n      A: 1.1,\n      E: 1.0,\n      O: 1.2,\n      U: 1.1,\n      N: 1.1,\n      S: 1.0\n    };\n\n    function calculateTextWidth(text) {\n      return Array.from(text).reduce(\n        (width, char) => width + (charWidths[char] || 1.0),\n        0\n      );\n    }\n\n    const lineWidths = allLines.map((line) => {\n      const trimmedLine = line.trim();\n      const isLatinText = !/[^A-Za-z0-9\\s\\-.,!?:;@]/.test(trimmedLine);\n      return isLatinText\n        ? calculateTextWidth(trimmedLine)\n        : trimmedLine.length;\n    });\n    let maxLength = Math.max(...lineWidths);\n\n    if (getBoxInfo) return [maxLength, allLines.length];\n\n    const html = allLines\n      .map(\n        (d, i) => `<tspan x=${-maxLength / 3}em dy=${1}em>${d.trim()}</tspan>`\n      )\n      .join(\"\");\n    return `<tspan x=${0}em y=${-allLines.length / 2}em>${html}</tspan>`;\n  },\n\n  /**\n   * Calculate label height offset based on font size and line count\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @returns {number} Height offset value\n   */\n  getLabelHeightOffset: function (self, d) {\n    const fontSize = this.fontScale(self.hierarchy, d);\n    const [width, lineRows] = this.multiline(d.data.key, true);\n    const boxHeight = fontSize * 8 * (lineRows - 2);\n    return boxHeight;\n  },\n\n  /**\n   * Calculate optimal label position within parent polygon\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @returns {number[]|undefined} [x, y] position or undefined for depth 1 nodes\n   */\n  getLabelPos: function (self, d) {\n    if (d.depth === 1) return [0, 0];\n    if (!d.parent?.polygon?.site || !d.polygon?.site) return [0, 0];\n    const parentCenter = d.parent.polygon.site;\n    const currentCenter = d.polygon.site;\n    if (d.parent.children.length > 1)\n      return [currentCenter.x, currentCenter.y];\n\n    const diffX = currentCenter.x - parentCenter.x;\n    const diffY = currentCenter.y - parentCenter.y;\n    let offY = 0,\n      offX = 0;\n\n    const fontSize = this.fontScale2(self.hierarchy, d);\n    const [meanWidth, lineRows] = this.multiline(d.data.key, true);\n    const boxHeight = fontSize * 6 * lineRows;\n    const boxWidth = fontSize * 6 * meanWidth;\n    const minOffset = Math.max(18, boxHeight / 2);\n\n    if (Math.abs(diffY) < minOffset) {\n      offY = diffY >= 0 ? minOffset : -minOffset;\n      if (Math.abs(diffX) < boxWidth) {\n        offX = diffX >= 0 ? boxWidth / 2 : -boxWidth / 2;\n      }\n    }\n\n    const parentBounds = this.getPolygonBounds(d.parent.polygon);\n    const proposedX = currentCenter.x + offX;\n    const proposedY = currentCenter.y + offY;\n\n    if (proposedX < parentBounds.minX + boxWidth / 2) {\n      offX = parentBounds.minX + boxWidth / 2 - currentCenter.x;\n    } else if (proposedX > parentBounds.maxX - boxWidth / 2) {\n      offX = parentBounds.maxX - boxWidth / 2 - currentCenter.x;\n    }\n    if (proposedY < parentBounds.minY + boxHeight / 2) {\n      offY = parentBounds.minY + boxHeight / 2 - currentCenter.y;\n    } else if (proposedY > parentBounds.maxY - boxHeight / 2) {\n      offY = parentBounds.maxY - boxHeight / 2 - currentCenter.y;\n    }\n\n    return [currentCenter.x + offX, currentCenter.y + offY];\n  },\n\n  /**\n   * Get bounding box of a polygon\n   * @param {number[][]} polygon - Array of [x, y] coordinate pairs\n   * @returns {Object} { minX, maxX, minY, maxY }\n   */\n  getPolygonBounds: function (polygon) {\n    const xs = polygon.map((point) => point[0]);\n    const ys = polygon.map((point) => point[1]);\n    return {\n      minX: Math.min(...xs),\n      maxX: Math.max(...xs),\n      minY: Math.min(...ys),\n      maxY: Math.max(...ys)\n    };\n  },\n\n  /**\n   * Estimate polygon radius from area\n   * @param {Object} d - Node with polygon data\n   * @returns {number} Estimated radius\n   */\n  estimatePolygonRadius: function (d) {\n    if (!d.polygon?.site?.originalObject?.polygon) return 0;\n    const area = d.polygon.site.originalObject.polygon.area();\n    return Math.sqrt(area / Math.PI);\n  },\n\n  /**\n   * Estimate label width based on font size and text length\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @param {number} [fontMultiplier=1] - Font size multiplier\n   * @returns {number} Estimated width (minimum 60)\n   */\n  estimateLabelWidth: function (self, d, fontMultiplier) {\n    fontMultiplier = fontMultiplier || 1;\n    const fontSize = this.fontScale(self.hierarchy, d) * fontMultiplier;\n    const [maxWidth, lineCount] = this.multiline(d.data.key, true);\n    return Math.max(fontSize * 16 * maxWidth * 0.8, 60);\n  },\n\n  /**\n   * Estimate label height based on font size and line count\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @param {number} [fontMultiplier=1] - Font size multiplier\n   * @returns {number} Estimated height (minimum 40)\n   */\n  estimateLabelHeight: function (self, d, fontMultiplier) {\n    fontMultiplier = fontMultiplier || 1;\n    const fontSize = this.fontScale(self.hierarchy, d) * fontMultiplier;\n    const [maxWidth, lineCount] = this.multiline(d.data.key, true);\n    return Math.max(fontSize * 16 * lineCount * 1.5, 40);\n  },\n\n  /**\n   * Create context object for custom label renderers\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object} d - Current node\n   * @param {number} depth - Depth level (1 or 2)\n   * @returns {Object} Context object with label rendering information\n   */\n  createLabelContext: function (self, d, depth) {\n    return {\n      key: d.data.key,\n      value: d.value,\n      depth: d.depth,\n      data: d.data.values[0]?.data,\n      ratio: d.value / self.totalValue,\n      percentText: d3.format(\".0%\")(d.value / self.totalValue),\n      color: d.color,\n      parentColor: d.parent?.color,\n      darkerColor: this.getHSLColor(d.color, 0, -0.1, -0.2),\n      lighterColor: this.getHSLColor(d.color, 0, 0.1, 0.1),\n      fontSize:\n        depth === 1\n          ? this.fontScale(self.hierarchy, d) * 1.15\n          : this.fontScale(self.hierarchy, d),\n      centerX: d.polygon?.site?.x ?? 0,\n      centerY: d.polygon?.site?.y ?? 0,\n      polygon: d.polygon,\n      parent: d.parent\n        ? {\n            key: d.parent.data.key,\n            value: d.parent.value,\n            color: d.parent.color\n          }\n        : null,\n      children: d.children\n        ? d.children.map((c) => ({\n            key: c.data.key,\n            value: c.value,\n            color: c.color\n          }))\n        : null,\n      totalValue: self.totalValue,\n      formatNumber: (n) => this.bigFormat(n),\n      formatPercent: (n) => d3.format(\".1%\")(n)\n    };\n  },\n\n  // === Number Format Functions ===\n\n  /**\n   * Format large numbers with Korean units (조, 억, 만)\n   * @param {number} n - Number to format\n   * @returns {string} Formatted string with Korean number units\n   */\n  bigFormat: function (n) {\n    const 조 = n > 10 ** 12 ? Math.floor(n / 10 ** 12) % 10 ** 4 : 0;\n    const 억 = n > 10 ** 8 ? Math.round(n / 10 ** 8) % 10 ** 4 : 0;\n    const 만 = parseInt(n / 10 ** 4) % 10 ** 4;\n\n    return (\n      (조 >= 1 ? d3.format(\",.0f\")(조) + \"조 \" : \" \") +\n      (억 >= 1 ? d3.format(\",.0f\")(억) + \"억 \" : \" \") +\n      (n < 10 ** 10 && 만 >= 1 ? d3.format(\",.0f\")(만) + \"만 \" : \" \") +\n      (n < 10 ** 4 ? d3.format(\",.0f\")(Math.round(n)) : \" \")\n    );\n  },\n\n  // === Custom Voronoi Algorithm ===\n\n  /**\n   * Create a custom voronoi treemap algorithm with initial position support\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {boolean} [debug=false] - Enable debug mode\n   * @returns {Function} Voronoi treemap algorithm function\n   */\n  createCustomVoronoiAlgorithm: function (self, debug) {\n    debug = debug || false;\n    const DEFAULT_CONVERGENCE_RATIO = 0.01;\n    const DEFAULT_MAX_ITERATION_COUNT = 50;\n    const DEFAULT_MIN_WEIGHT_RATIO = 0.01;\n    const DEFAULT_PRNG = Math.random;\n\n    var clip = [\n      [0, 0],\n      [0, 1],\n      [1, 1],\n      [1, 0]\n    ];\n    var extent = [\n      [0, 0],\n      [1, 1]\n    ];\n    var size = [1, 1];\n    var convergenceRatio = DEFAULT_CONVERGENCE_RATIO;\n    var maxIterationCount = DEFAULT_MAX_ITERATION_COUNT;\n    var minWeightRatio = DEFAULT_MIN_WEIGHT_RATIO;\n    var prng = DEFAULT_PRNG;\n    var initialPositions = {};\n\n    var unrelevantButNeedeData = [{ weight: 1 }, { weight: 1 }];\n    var _convenientReusableVoronoiMapSimulation = d3\n      .voronoiMapSimulation(unrelevantButNeedeData)\n      .stop();\n\n    const helpers = this;\n\n    const _voronoiTreemap = function (rootNode) {\n      recurse(clip, rootNode);\n    };\n\n    _voronoiTreemap.convergenceRatio = function (_) {\n      return arguments.length\n        ? ((convergenceRatio = _), _voronoiTreemap)\n        : convergenceRatio;\n    };\n    _voronoiTreemap.maxIterationCount = function (_) {\n      return arguments.length\n        ? ((maxIterationCount = _), _voronoiTreemap)\n        : maxIterationCount;\n    };\n    _voronoiTreemap.minWeightRatio = function (_) {\n      return arguments.length\n        ? ((minWeightRatio = _), _voronoiTreemap)\n        : minWeightRatio;\n    };\n    _voronoiTreemap.clip = function (_) {\n      if (!arguments.length) return clip;\n      _convenientReusableVoronoiMapSimulation.clip(_);\n      clip = _convenientReusableVoronoiMapSimulation.clip();\n      extent = _convenientReusableVoronoiMapSimulation.extent();\n      size = _convenientReusableVoronoiMapSimulation.size();\n      return _voronoiTreemap;\n    };\n    _voronoiTreemap.extent = function (_) {\n      if (!arguments.length) return extent;\n      _convenientReusableVoronoiMapSimulation.extent(_);\n      clip = _convenientReusableVoronoiMapSimulation.clip();\n      extent = _convenientReusableVoronoiMapSimulation.extent();\n      size = _convenientReusableVoronoiMapSimulation.size();\n      return _voronoiTreemap;\n    };\n    _voronoiTreemap.size = function (_) {\n      if (!arguments.length) return size;\n      _convenientReusableVoronoiMapSimulation.size(_);\n      clip = _convenientReusableVoronoiMapSimulation.clip();\n      extent = _convenientReusableVoronoiMapSimulation.extent();\n      size = _convenientReusableVoronoiMapSimulation.size();\n      return _voronoiTreemap;\n    };\n    _voronoiTreemap.prng = function (_) {\n      return arguments.length ? ((prng = _), _voronoiTreemap) : prng;\n    };\n    _voronoiTreemap.initialPositions = function (_) {\n      return arguments.length\n        ? ((initialPositions = _), _voronoiTreemap)\n        : initialPositions;\n    };\n\n    const recurse = function (clippingPolygon, node) {\n      var simulation;\n      node.polygon = clippingPolygon;\n\n      if (node.height != 0) {\n        simulation = d3\n          .voronoiMapSimulation(node.children)\n          .clip(clippingPolygon)\n          .weight((d) => d.value)\n          .convergenceRatio(convergenceRatio)\n          .maxIterationCount(maxIterationCount)\n          .minWeightRatio(minWeightRatio)\n          .prng(prng)\n          .initialPosition(\n            helpers.createInitialPositioner(self, initialPositions, debug)\n          )\n          .stop();\n\n        var state = simulation.state();\n        while (!state.ended) {\n          simulation.tick();\n          state = simulation.state();\n        }\n\n        state.polygons.forEach(function (cp) {\n          if (cp.site?.originalObject?.data?.originalData) {\n            recurse(cp, cp.site.originalObject.data.originalData);\n          }\n        });\n      }\n    };\n\n    return _voronoiTreemap;\n  },\n\n  /**\n   * Create initial position function for voronoi simulation\n   * @param {Object} self - VoronoiTreemap instance\n   * @param {Object[]} initialPositions - Array of initial position objects\n   * @param {boolean} [debug=false] - Enable debug mode\n   * @returns {Function} Position function for voronoi simulation\n   */\n  createInitialPositioner: function (self, initialPositions, debug) {\n    debug = debug || false;\n    var clippingPolygon, extent, minX, maxX, minY, maxY, dx, dy;\n\n    function updateInternals() {\n      minX = extent[0][0];\n      maxX = extent[1][0];\n      minY = extent[0][1];\n      maxY = extent[1][1];\n      dx = maxX - minX;\n      dy = maxY - minY;\n    }\n\n    function findNodeInitialPosition(node, initialPositions) {\n      return initialPositions.find(\n        (pos) => pos.depth === node.depth && pos.key === node.data.key\n      );\n    }\n\n    function getSiblingInitialPositions(siblings, initialPositions) {\n      return siblings\n        .map((sibling) => findNodeInitialPosition(sibling, initialPositions))\n        .filter((pos) => pos !== undefined);\n    }\n\n    function getPolygonAngles(clippingPolygon) {\n      const polygonXExtent = d3.extent(clippingPolygon, (d) => d[0]);\n      const polygonYExtent = d3.extent(clippingPolygon, (d) => d[1]);\n\n      return clippingPolygon\n        .map((point) => {\n          const x = d3.scaleLinear().domain(polygonXExtent).range([-1, 1])(\n            point[0]\n          );\n          const y = d3.scaleLinear().domain(polygonYExtent).range([-1, 1])(\n            point[1]\n          );\n          const angle = Math.atan2(y, x);\n          return {\n            angle: angle < 0 ? angle + 2 * Math.PI : angle,\n            point: point,\n            x: x,\n            y: y\n          };\n        })\n        .sort((a, b) => a.angle - b.angle);\n    }\n\n    function mapPointToPolygon(x, y, polygonAngles, clippingPolygon) {\n      const angle = Math.atan2(y, x);\n      const normalizedAngle = angle < 0 ? angle + 2 * Math.PI : angle;\n\n      let startAngle, endAngle, startPoint, endPoint;\n      for (let i = 0; i < polygonAngles.length; i++) {\n        if (normalizedAngle <= polygonAngles[i].angle) {\n          startAngle =\n            i === 0\n              ? polygonAngles[polygonAngles.length - 1].angle\n              : polygonAngles[i - 1].angle;\n          endAngle = polygonAngles[i].angle;\n          startPoint =\n            i === 0\n              ? polygonAngles[polygonAngles.length - 1]\n              : polygonAngles[i - 1];\n          endPoint = polygonAngles[i];\n          break;\n        }\n      }\n\n      if (startAngle === undefined) {\n        startAngle = polygonAngles[polygonAngles.length - 1].angle;\n        endAngle = polygonAngles[0].angle + 2 * Math.PI;\n        startPoint = polygonAngles[polygonAngles.length - 1];\n        endPoint = polygonAngles[0];\n      }\n\n      const t = (normalizedAngle - startAngle) / (endAngle - startAngle);\n      const edgeX = startPoint.x + t * (endPoint.x - startPoint.x);\n      const edgeY = startPoint.y + t * (endPoint.y - startPoint.y);\n\n      const distanceToPoint = Math.sqrt(x * x + y * y);\n      const maxDistance = Math.sqrt(2);\n      const ratio = (distanceToPoint / maxDistance) * 0.9;\n\n      const mappedX = ratio * edgeX;\n      const mappedY = ratio * edgeY;\n\n      const polygonXExtent = d3.extent(clippingPolygon, (d) => d[0]);\n      const polygonYExtent = d3.extent(clippingPolygon, (d) => d[1]);\n\n      const finalX = d3.scaleLinear().domain([-1, 1]).range(polygonXExtent)(\n        mappedX\n      );\n      const finalY = d3.scaleLinear().domain([-1, 1]).range(polygonYExtent)(\n        mappedY\n      );\n\n      return [finalX, finalY, normalizedAngle, ratio, [x, y]];\n    }\n\n    const _random = function (d, i, arr, voronoiMapSimulation) {\n      var shouldUpdateInternals = false;\n      if (clippingPolygon !== voronoiMapSimulation.clip()) {\n        clippingPolygon = voronoiMapSimulation.clip();\n        extent = voronoiMapSimulation.extent();\n        shouldUpdateInternals = true;\n      }\n      if (shouldUpdateInternals) {\n        updateInternals();\n      }\n\n      if (d.depth === 0) {\n        return [(minX + maxX) / 2, (minY + maxY) / 2];\n      }\n\n      const parent = d.parent || arr[0].parent;\n      const siblings = parent ? parent.children : arr;\n      const siblingInitialPositions = getSiblingInitialPositions(\n        siblings,\n        initialPositions\n      );\n\n      if (siblingInitialPositions.length > 0) {\n        const siblingXExtent = d3.extent(siblingInitialPositions, (d) => d.x);\n        const siblingYExtent = d3.extent(siblingInitialPositions, (d) => d.y);\n        const nodeInitialPosition = findNodeInitialPosition(\n          d,\n          initialPositions\n        );\n\n        if (nodeInitialPosition) {\n          const x = nodeInitialPosition.x * self.width;\n          const y = nodeInitialPosition.y * self.height;\n\n          if (d3.polygonContains(clippingPolygon, [x, y])) {\n            return [x, y];\n          }\n\n          const [mappedX, mappedY] = mapPointToPolygon(\n            d3.scaleLinear().domain(siblingXExtent).range([-1, 1])(\n              nodeInitialPosition.x\n            ),\n            d3.scaleLinear().domain(siblingYExtent).range([-1, 1])(\n              nodeInitialPosition.y\n            ),\n            getPolygonAngles(clippingPolygon),\n            clippingPolygon\n          );\n\n          return [mappedX, mappedY];\n        }\n      }\n\n      // Fallback: random position\n      let x, y;\n      do {\n        x = minX + dx * voronoiMapSimulation.prng()();\n        y = minY + dy * voronoiMapSimulation.prng()();\n      } while (!d3.polygonContains(clippingPolygon, [x, y]));\n\n      return [x, y];\n    };\n\n    return _random;\n  }\n};\n\nexport { VoronoiTreemapHelpers };\nexport default VoronoiTreemapHelpers;\n","/**\n * PopupHelpers\n *\n * Helper functions for creating popup displays when cells are clicked.\n * These are optional utilities that can be used with the clickFunc option.\n */\n\n/**\n * Default popup function for Observable notebooks\n * Returns an HTML element that displays information about the clicked cell\n *\n * @param {Object} clickedData - The data object passed from the click event\n * @param {Object} clickedData.data - The data associated with the clicked cell\n * @param {Event} clickedData.event - The original click event\n * @returns {HTMLElement|null} HTML element for Observable to display, or null if no data\n *\n * @example\n * // In Observable notebook\n * import { VoronoiTreemap, showVoronoiPopup } from \"...\"\n *\n * chart = {\n *   const treemap = new VoronoiTreemap();\n *   return treemap.render(data, {\n *     clickFunc: showVoronoiPopup\n *   });\n * }\n */\nexport function showVoronoiPopup(clickedData) {\n  if (!clickedData) return null;\n\n  const data = clickedData.data || {};\n\n  // This uses Observable's html template literal\n  // For non-Observable environments, use createDOMPopup instead\n  if (typeof html !== 'undefined') {\n    return html`<div style=\"\n      background: #fffe;\n      border: 2px solid #555;\n      border-radius: 15px;\n      padding: 15px;\n      max-width: 350px;\n      min-width: 200px;\n    \">\n      <div style=\"font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em;\">\n        ${data.bigClusterLabel || 'N/A'}\n      </div>\n      <div style=\"margin-bottom: 0.3em;\">\n        <strong>Region:</strong> ${data.region || 'N/A'}\n      </div>\n      <div>\n        <strong>Size:</strong> ${data.bubbleSize || 'N/A'}\n      </div>\n    </div>`;\n  }\n\n  // Fallback for non-Observable environments\n  return createDOMPopup(clickedData);\n}\n\n/**\n * Create a DOM-based popup for standard web pages (non-Observable)\n * This creates an absolutely positioned popup at the click location\n *\n * @param {Object} clickedData - The data object passed from the click event\n * @param {Object} clickedData.data - The data associated with the clicked cell\n * @param {Event} clickedData.event - The original click event\n * @returns {HTMLElement|null} DOM element to be appended to the page\n *\n * @example\n * // In standard HTML/JavaScript\n * const treemap = new VoronoiTreemap();\n * const svg = treemap.render(data, {\n *   clickFunc: createDOMPopup\n * });\n */\nexport function createDOMPopup(clickedData) {\n  // Remove existing popup\n  const existingPopup = document.querySelector('.voronoi-popup-content');\n  if (existingPopup) existingPopup.remove();\n\n  if (!clickedData) {\n    return null;\n  }\n\n  const event = clickedData.event;\n  const data = clickedData.data || {};\n\n  // Create popup\n  const popup = document.createElement('div');\n  popup.className = 'voronoi-popup-content';\n\n  // Position at click location\n  const x = event.pageX;\n  const y = event.pageY;\n  popup.style.left = x + 'px';\n  popup.style.top = y + 'px';\n\n  // Create popup content\n  const content = document.createElement('div');\n  content.className = 'voronoi-popup-message';\n  content.innerHTML = `\n    <div style=\"font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em;\">\n      ${data.bigClusterLabel || 'N/A'}\n    </div>\n    <div style=\"margin-bottom: 0.3em;\">\n      <strong>Region:</strong> ${data.region || 'N/A'}\n    </div>\n    <div>\n      <strong>Size:</strong> ${data.bubbleSize || 'N/A'}\n    </div>\n  `;\n\n  popup.appendChild(content);\n  document.body.appendChild(popup);\n\n  // Close on click outside\n  setTimeout(() => {\n    const closeHandler = (e) => {\n      if (!popup.contains(e.target)) {\n        popup.remove();\n        document.removeEventListener('click', closeHandler);\n      }\n    };\n    document.addEventListener('click', closeHandler);\n  }, 0);\n\n  return popup;\n}\n\n/**\n * Get the recommended CSS styles for popups\n * Returns a string of CSS that can be added to your page\n *\n * @returns {string} CSS string for popup styles\n *\n * @example\n * // In Observable\n * html`<style>${getPopupStyles()}</style>`\n *\n * @example\n * // In standard HTML\n * const style = document.createElement('style');\n * style.textContent = getPopupStyles();\n * document.head.appendChild(style);\n */\nexport function getPopupStyles() {\n  return `\n.voronoi-popup-content {\n  position: absolute;\n  background: #fffe;\n  border: 2px solid #555;\n  border-radius: 30px;\n  padding: 10px;\n  z-index: 1000000;\n  transform: translateX(-50%) translateY(-100%);\n  min-width: 100px;\n}\n\n.voronoi-popup-content::before {\n  content: \" \";\n  position: absolute;\n  top: 100%;\n  left: 50%;\n  margin-left: -10px;\n  border-width: 10px;\n  border-style: solid;\n  border-color: #555 transparent transparent transparent;\n}\n\n.voronoi-popup-content::after {\n  content: \" \";\n  position: absolute;\n  top: 100%;\n  left: 50%;\n  margin-left: -8px;\n  border-width: 8px;\n  border-style: solid;\n  border-color: #fff transparent transparent transparent;\n}\n\n.voronoi-popup-message {\n  max-width: 350px;\n  min-width: 200px;\n  padding: 1em;\n  line-height: 1.5;\n  color: #444;\n  text-align: left;\n  max-height: 400px;\n  overflow-y: scroll;\n  overflow-x: clip;\n}\n`;\n}\n\n/**\n * Get comprehensive CSS styles for bubble/voronoi visualizations\n * Returns a string of CSS including fonts, regions, areas, labels, and popups\n *\n * @returns {string} CSS string for all bubble styles\n *\n * @example\n * // In Observable\n * html`<style>${getBubbleStyles()}</style>`\n *\n * @example\n * // In standard HTML\n * const style = document.createElement('style');\n * style.textContent = getBubbleStyles();\n * document.head.appendChild(style);\n */\nexport function getBubbleStyles() {\n  return `\n@font-face {\n    font-family: 'KoddiUD OnGothic';\n    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2105_2@1.0/KoddiUDOnGothic-Regular.woff') format('woff');\n    font-weight: normal;\n    font-style: normal;\n}\n\n@font-face {\n    font-family: 'KoddiUDOnGothic-Bold';\n    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2105_2@1.0/KoddiUDOnGothic-Bold.woff') format('woff');\n    font-weight: normal;\n    font-style: normal;\n}\n\nbody {\n    font-family: \"KoddiUD OnGothic\", sans-serif;\n}\n\n.caption {\n    color: #888;\n}\n\n.region {\n    font-family: \"KoddiUDOnGothic-Bold\", \"KoddiUD OnGothic\", sans-serif;\n    fill: #fff;\n    fill-opacity: 1;\n    font-weight: 700;\n    stroke-width: 3px;\n    pointer-events: none;\n}\n\n.area1 {\n    stroke: #464749aa;\n    stroke-width: 2;\n}\n\n.area2 {\n    stroke: #ffffffb0;\n    stroke-width: 0.5;\n}\n\n.area2.highlite {\n    filter: hue-rotate(-5deg) brightness(0.95);\n}\n\n.area2.clicked {\n    stroke: #000;\n    stroke-width: 3px;\n    filter: brightness(0.9);\n}\n\n.regionArea1 {\n    stroke: #464749aa;\n    stroke-width: 1.5;\n}\n\n.regionArea2 {\n    stroke: #46474955;\n    stroke-width: 0.7;\n}\n\n.regionArea3 {\n    stroke: #ffffffb0;\n    stroke-width: 0.5;\n    cursor: pointer;\n}\n\n.regionArea3.clicked {\n    stroke-width: 1px;\n    filter: hue-rotate(-5deg) brightness(0.9);\n}\n\n.regionArea3.highlite,\n.regionArea3:hover {\n    filter: hue-rotate(-5deg) brightness(0.95);\n}\n\n.field {\n    font-size: 1.2em;\n    font-weight: 600;\n    fill: #000d;\n    pointer-events: none;\n}\n\n.sector {\n    font-size: 0.8em;\n    font-weight: 400;\n    fill: #a95b5bdd;\n    cursor: default;\n    pointer-events: none;\n}\n\n.budget {\n    fill: #c25a50;\n    font-size: 12px;\n    cursor: default;\n    pointer-events: none;\n}\n\n.percent .budget {\n    fill: #fff;\n}\n\n.bubblepopup {\n    max-width: 350px;\n    min-width: 200px;\n    padding: 1em;\n    line-height: 1.5;\n    color: #444;\n    text-align: left;\n    max-height: 400px;\n    overflow: scroll;\n}\n\n.voronoi-popup-content {\n    position: absolute;\n    background: #fffe;\n    border: 2px solid #555;\n    border-radius: 30px;\n    padding: 10px;\n    z-index: 1000000;\n    transform: translateX(-50%) translateY(-100%);\n    min-width: 100px;\n}\n\n.voronoi-popup-content::before {\n    content: \" \";\n    position: absolute;\n    top: 100%;\n    left: 50%;\n    margin-left: -10px;\n    border-width: 10px;\n    border-style: solid;\n    border-color: #555 transparent transparent transparent;\n}\n\n.voronoi-popup-content::after {\n    content: \" \";\n    position: absolute;\n    top: 100%;\n    left: 50%;\n    margin-left: -8px;\n    border-width: 8px;\n    border-style: solid;\n    border-color: #fff transparent transparent transparent;\n}\n\n.voronoi-popup-message {\n    max-width: 350px;\n    min-width: 200px;\n    padding: 1em;\n    line-height: 1.5;\n    color: #444;\n    text-align: left;\n    max-height: 400px;\n    overflow-y: scroll;\n    overflow-x: clip;\n}\n`;\n}\n\nexport default {\n  showVoronoiPopup,\n  createDOMPopup,\n  getPopupStyles,\n  getBubbleStyles\n};\n","/**\n * VoronoiTreemap\n *\n * Main class for creating voronoi treemap visualizations.\n * Renders hierarchical data as organic, pebble-like cells using\n * D3.js and voronoi treemap algorithms.\n *\n * Features:\n * - Hierarchical voronoi treemap layout\n * - Customizable colors, labels, and sizing\n * - Interactive click and hover events\n * - Pebble-style rounded outlines\n * - Label collision detection and adjustment\n * - Region position control for deterministic layouts\n */\n\nimport d3 from './utils/d3-bundle.js';\nimport { PebbleRenderer } from './PebbleRenderer.js';\nimport { LabelAdjuster } from './LabelAdjuster.js';\nimport { nestingForVoronoi } from './nestingForVoronoi.js';\nimport VoronoiTreemapHelpers from './VoronoiTreemapHelpers.js';\nimport { getBubbleStyles } from './PopupHelpers.js';\n\n/**\n * VoronoiTreemap - Main visualization class\n *\n * @example\n * const treemap = new VoronoiTreemap();\n * const svg = treemap.render(data, {\n *   width: 800,\n *   height: 600,\n *   maptitle: 'My Treemap'\n * });\n * document.body.appendChild(svg);\n */\nclass VoronoiTreemap {\n  constructor() {\n    this.margin = { top: 50, right: 50, bottom: 50, left: 50 };\n    this.svg = null;\n    this.data = null;\n    this.hierarchy = null;\n    this.allNodes = null;\n    this._pebbleRenderer = null;\n    this._labelAdjuster = null;\n  }\n\n  // === Default Color Palette ===\n  static get DEFAULT_COLORS() {\n    return \"#afc7dd,#ffe9a9,#f69f8f,#b4c8af,#e9e4d6,#bed1d8,#f8dba1,#fcbc8b,#d7e0c4,#c5b5a6,#b5ccc1,#e9bfb4,#e9f0f6,#fffefb,#fce0db,#e1e9df,#f1f5f7,#fef8ed,#feeada,#fbfcf9,#e5ded7,#e5edea,#fbf5f3,#96b6d3,#ffdf85,#f3836e,#a0b99a,#ddd4be,#a7c1cb,#f5cf80,#fba868,#c7d4ac,#b7a490,#a0bdb0,#e1a799,#d7e3ee,#fff7e1,#facbc3,#d3dfd0,#fdfcfa,#e1eaed,#fcefd5,#fddcc2,#f0f3e9,#dbd2c8,#d6e3dd,#f6e4df,#dee8f1,#fffaeb,#fbd4cc,#d9e3d6,#e7eef1,#fcf3df,#fee1cc,#f4f7ef,#dfd7ce,#dce7e2,#f8ebe7,#e5edf4,#fffdf5,#fcdcd6,#dfe7dc,#eef3f5,#fdf6e8,#fee7d6,#f9faf6,#e3dcd4,#e2ebe7,#faf1ef,#d0b7ba,#b8cec4,#d2b6b6,#b6bdd6,#d9b8b7,#ded5b6,#bac2d7,#c8d5be,#e3bfb7,#f9dfb3,#eac2b8,#c1d3da,#ddc7c1,#d9e2c7,#cfdad5,#eecdc1,#ccdddf,#c7d7e6,#ded6cf,#e7d1cb,#ced9e5,#eedbc8,#d7e3e2,#e3ead2,#ecdcd2,#d9e0e5,#efe1d2,#ebdad7,#eed6da,#e1e6de,#dde4e8,#eee1d8,#f5e8d7,#f1e6dd,#f5e8de,#f3e7e1,#f5eee1,#f5f2ec\".split(\n      \",\"\n    );\n  }\n\n  // === Default Options ===\n  static get DEFAULT_OPTIONS() {\n    return {\n      width: 500,\n      height: 300,\n      maptitle: \"\",\n      caption: \"\",\n      clickFunc: () => {},\n      colorFunc: null,\n      getCellColors: null, // (cellColors) => void - Callback to receive actual cell colors\n      sizeLimit: 1000,\n      ratioLimit: 0,\n      pieSize: 1,\n      colors: VoronoiTreemap.DEFAULT_COLORS,\n      seedRandom: 10,\n      showRegion: false,\n      showPercent: false,\n      underLabel: false,\n      regionPositions: null,\n      forceNodeFunc: null,\n      debug: false,\n      pebbleRound: 25,\n      pebbleWidth: 3,\n      regionColors: [],\n      // Custom label renderer options\n      regionLabelRenderer: null, // (datum, defaultHtml, context) => HTML string\n      bigClusterLabelRenderer: null // (datum, defaultHtml, context) => HTML string\n    };\n  }\n\n  // === Getter for post-processing modules ===\n  get pebbleRenderer() {\n    if (!this._pebbleRenderer) {\n      this._pebbleRenderer = new PebbleRenderer(d3);\n    }\n    return this._pebbleRenderer;\n  }\n\n  get labelAdjuster() {\n    if (!this._labelAdjuster) {\n      this._labelAdjuster = new LabelAdjuster(d3);\n    }\n    return this._labelAdjuster;\n  }\n\n  // === Public Methods ===\n\n  /**\n   * Render chart - returns SVG element\n   * @param {Object[]} data - Data array to visualize\n   * @param {Object} [options] - Rendering options\n   * @returns {SVGSVGElement} - Generated SVG element\n   */\n  render(data, options = {}) {\n    this.params = { ...VoronoiTreemap.DEFAULT_OPTIONS, ...options };\n    this.data = data;\n\n    this._setupSVG();\n    this._prepareData();\n    this._setupGroups();\n    this._drawTitleAndCaption();\n    this._createRegionColorScale();\n    this._computeLayout();\n    this._drawCells();\n    this._drawLabels();\n    this._buildLabelCache();\n    this._applyPostEffects();\n\n    return this.svg.node();\n  }\n\n  /**\n   * Update chart (data only)\n   * @param {Object[]} newData - New data\n   * @returns {SVGSVGElement}\n   */\n  update(newData) {\n    return this.render(newData, this.params);\n  }\n\n  // === 1. Initial Setup Methods ===\n\n  _setupSVG() {\n    // Create independent SVG element (no container needed)\n    this.svg = d3\n      .create(\"svg\")\n      .attr(\"width\", this.params.width + this.margin.left + this.margin.right)\n      .attr(\n        \"height\",\n        this.params.height + this.margin.top + this.margin.bottom\n      );\n\n    // Inject bubble styles (includes :hover rules)\n    this.svg.append(\"style\").text(getBubbleStyles());\n\n    this.svg\n      .append(\"rect\")\n      .attr(\"width\", \"100%\")\n      .attr(\"height\", \"100%\")\n      .style(\"fill\", \"#fff\");\n\n    this.width = this.params.width * Math.sqrt(this.params.pieSize);\n    this.height = this.width * (this.params.height / this.params.width);\n  }\n\n  _prepareData() {\n    // Use external nestingForVoronoi function\n    const nested = nestingForVoronoi(\n      this.data,\n      \"bigClusterLabel\",\n      \"clusterLabel\"\n    );\n\n    this.hierarchy = d3.hierarchy(nested, (d) => d.values).sum((d) => d.size);\n\n    this.totalValue = this.hierarchy.value;\n  }\n\n  _setupGroups() {\n    this.chartGroup = this.svg\n      .append(\"g\")\n      .attr(\"transform\", `translate(${this.margin.left},${this.margin.top})`);\n\n    this.voronoiGroup = this.chartGroup.append(\"g\").attr(\"class\", \"cell\");\n    this.labelsGroup = this.chartGroup.append(\"g\").attr(\"class\", \"labels\");\n    this.popLabelsGroup = this.chartGroup.append(\"g\").attr(\"class\", \"pop\");\n    this.bigLabelsGroup = this.chartGroup.append(\"g\").attr(\"class\", \"label1\");\n    this.percentLabelsGroup = this.chartGroup\n      .append(\"g\")\n      .attr(\"class\", \"percent\");\n    this.regionLabelsGroup = this.chartGroup\n      .append(\"g\")\n      .attr(\"class\", \"region\");\n  }\n\n  _drawTitleAndCaption() {\n    this.svg\n      .append(\"g\")\n      .append(\"text\")\n      .attr(\"class\", \"title\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"font-size\", \"22\")\n      .attr(\"font-weight\", \"600\")\n      .attr(\n        \"transform\",\n        `translate(${this.margin.left + this.width / 2},${\n          this.margin.top - 15\n        })`\n      )\n      .html(this.params.maptitle);\n\n    this.svg\n      .append(\"g\")\n      .append(\"text\")\n      .attr(\"class\", \"caption\")\n      .attr(\"text-anchor\", \"middle\")\n      .attr(\"font-size\", \"15\")\n      .attr(\"font-weight\", \"400\")\n      .attr(\"fill\", \"#888\")\n      .attr(\n        \"transform\",\n        `translate(${this.margin.left + this.width / 2},${\n          this.margin.top + this.height + 30\n        })`\n      )\n      .html(this.params.caption);\n  }\n\n  _createRegionColorScale() {\n    // Calculate total size (bubbleSize) per region\n    const regionSizes = d3.rollup(\n      this.data,\n      (v) => d3.sum(v, (d) => parseFloat(d.bubbleSize) || 1),\n      (d) => d.region\n    );\n\n    // Sort regions by size (descending - largest first)\n    const sortedRegions = Array.from(regionSizes.entries())\n      .sort((a, b) => b[1] - a[1]) // b[1] - a[1]: descending order\n      .map((d) => d[0]); // Extract region names\n\n    const { regionColors, colors: paletteColors } = this.params;\n    const customColorMap = new Map(regionColors.map((d) => [d.key, d.color]));\n\n    let colorMapping = {};\n\n    // Assign colors to sorted regions (largest region gets first color)\n    sortedRegions.forEach((key, i) => {\n      colorMapping[key] = paletteColors[i % paletteColors.length];\n    });\n\n    // Override with custom region colors if specified\n    customColorMap.forEach((color, key) => {\n      colorMapping[key] = color;\n    });\n\n    this.regionColor = d3\n      .scaleOrdinal()\n      .domain(Object.keys(colorMapping))\n      .range(Object.values(colorMapping));\n  }\n\n  // === 2. Layout Calculation Methods ===\n\n  _computeLayout() {\n    const ellipse = d3.range(100).map((i) => {\n      let x = Math.cos((i / 50) * Math.PI);\n      const max = 0.92;\n      if (x > max) x = max + (x - max) * 0.5;\n      if (x < -max) x = -max + (x + max) * 0.5;\n      x = x / 0.94;\n      const y = Math.sin((i / 25) * Math.PI);\n      return [\n        (this.width * (1 + 0.99 * x)) / 2,\n        (this.height * (1 + 0.99 * y)) / 2\n      ];\n    });\n\n    const seed = d3.seedrandom(this.params.seedRandom);\n\n    let voronoiTreeMap = d3.voronoiTreemap().prng(seed).clip(ellipse);\n    voronoiTreeMap(this.hierarchy);\n\n    if (this.params.regionPositions && this.params.regionPositions !== 'auto') {\n      const mergedPositions = this._normalizePositions(\n        this.params.regionPositions\n      );\n\n      const modifiedVoronoiTreeMap =\n        VoronoiTreemapHelpers.createCustomVoronoiAlgorithm(\n          this,\n          this.params.debug\n        )\n          .size([this.width, this.height])\n          .clip(ellipse)\n          .prng(seed)\n          .initialPositions(mergedPositions);\n\n      modifiedVoronoiTreeMap(this.hierarchy);\n    }\n\n    VoronoiTreemapHelpers.colorHierarchy(this, this.hierarchy);\n\n    this.allNodes = this.hierarchy\n      .descendants()\n      .sort((a, b) => b.depth - a.depth)\n      .map((d, i) => Object.assign({}, d, { id: i }));\n\n    // Extract and provide cell colors if callback is provided\n    if (this.params.getCellColors) {\n      const cellColors = this._extractCellColors();\n      this.params.getCellColors(cellColors);\n    }\n  }\n\n  /**\n   * Extract cell colors from hierarchy nodes\n   * @returns {Array} Array of {depth, key, color} objects\n   * @private\n   */\n  _extractCellColors() {\n    const cellColors = [];\n\n    this.hierarchy.descendants().forEach(node => {\n      if (node.depth > 0) { // Skip root node (depth 0)\n        cellColors.push({\n          depth: node.depth,\n          key: node.data.key,\n          color: node.color\n        });\n      }\n    });\n\n    return cellColors;\n  }\n\n  _normalizePositions(regionPositions) {\n    const result = [];\n    const hierarchyNodes = this.hierarchy.descendants();\n\n    // Helper: Add jitter to duplicate positions to prevent voronoi algorithm failure\n    const addJitterForDuplicates = (positions, jitterAmount = 0.02) => {\n      const positionMap = new Map(); // key: \"x,y\" -> count\n\n      positions.forEach((pos) => {\n        const key = `${pos.x.toFixed(6)},${pos.y.toFixed(6)}`;\n        const count = positionMap.get(key) || 0;\n\n        if (count > 0) {\n          // Add jitter for duplicate positions (spread in a circle)\n          const angle = (count * 2.4) % (2 * Math.PI); // Golden angle for even distribution\n          const jitter = jitterAmount * Math.sqrt(count);\n          pos.x = Math.max(0.05, Math.min(0.95, pos.x + jitter * Math.cos(angle)));\n          pos.y = Math.max(0.05, Math.min(0.95, pos.y + jitter * Math.sin(angle)));\n        }\n\n        positionMap.set(key, count + 1);\n      });\n\n      return positions;\n    };\n\n    // depth 1: Normalize based on overall extent\n    const depth1 = regionPositions.filter((p) => p.depth === 1);\n    if (depth1.length > 0) {\n      const xExtent = d3.extent(depth1, (p) => p.x);\n      const yExtent = d3.extent(depth1, (p) => p.y);\n\n      const xScale =\n        xExtent[0] === xExtent[1]\n          ? () => 0.5\n          : d3.scaleLinear().domain(xExtent).range([0.15, 0.85]);\n      const yScale =\n        yExtent[0] === yExtent[1]\n          ? () => 0.5\n          : d3.scaleLinear().domain(yExtent).range([0.15, 0.85]);\n\n      const depth1Normalized = depth1.map((pos) => ({\n        ...pos,\n        x: xScale(pos.x),\n        y: yScale(pos.y)\n      }));\n\n      // Add jitter for any duplicate positions\n      addJitterForDuplicates(depth1Normalized);\n      result.push(...depth1Normalized);\n    }\n\n    // depth 2, 3: Find parent in hierarchy and normalize among siblings\n    [2, 3].forEach((depth) => {\n      const depthPositions = regionPositions.filter((p) => p.depth === depth);\n      if (depthPositions.length === 0) return;\n\n      // Find parent groups for nodes at this depth\n      const nodesAtDepth = hierarchyNodes.filter((n) => n.depth === depth);\n      const byParent = d3.group(nodesAtDepth, (n) => n.parent?.data?.key);\n\n      byParent.forEach((siblings, parentKey) => {\n        // Find regionPositions for these siblings\n        const siblingKeys = new Set(siblings.map((s) => s.data.key));\n        const siblingPositions = depthPositions.filter((p) =>\n          siblingKeys.has(p.key)\n        );\n\n        if (siblingPositions.length === 0) return;\n\n        const xExtent = d3.extent(siblingPositions, (p) => p.x);\n        const yExtent = d3.extent(siblingPositions, (p) => p.y);\n\n        const xScale =\n          xExtent[0] === xExtent[1]\n            ? () => 0.5\n            : d3.scaleLinear().domain(xExtent).range([0.15, 0.85]);\n        const yScale =\n          yExtent[0] === yExtent[1]\n            ? () => 0.5\n            : d3.scaleLinear().domain(yExtent).range([0.15, 0.85]);\n\n        const siblingNormalized = siblingPositions.map((pos) => ({\n          ...pos,\n          x: xScale(pos.x),\n          y: yScale(pos.y)\n        }));\n\n        // Add jitter for any duplicate positions within siblings\n        addJitterForDuplicates(siblingNormalized);\n        result.push(...siblingNormalized);\n      });\n    });\n\n    return result;\n  }\n\n  // === 3. Visualization Element Drawing Methods ===\n\n  _drawCells() {\n    const { clickFunc } = this.params;\n    const self = this;\n\n    this.voronoiGroup\n      .selectAll(\"path\")\n      .data(this.allNodes)\n      .enter()\n      .append(\"path\")\n      .attr(\"d\", (d) => \"M\" + d.polygon.join(\"L\") + \"Z\")\n      .style(\"fill\", (d) => d.color ?? d.parent.color)\n      .attr(\"class\", (d) => `regionArea${d.depth} area-${d.id}`)\n      .style(\"fill-opacity\", (d) => (d.depth === 3 ? 1 : 0))\n      .attr(\"pointer-events\", (d) => (d.depth === 3 ? \"all\" : \"none\"))\n      .on(\"click\", function (e, d) {\n        let area = self.voronoiGroup.select(`.area-${d.id}`);\n        const clicked = area.attr(\"class\").match(\"clicked\");\n        self.voronoiGroup.select(`.clicked`).classed(\"clicked\", false);\n        area.classed(\"clicked\", !clicked);\n        clickFunc(clicked ? \"\" : { ...d.data, event: e, d, clickArea: area });\n      })\n      .on(\"mouseenter\", function (e, d) {\n        // Label visibility - use cached lookups (O(1))\n        const label1 = self._bigClusterLabelCache?.get(d.data.data.bigClusterLabel);\n        if (label1) label1.node().style.opacity = 1;\n\n        const label = self._clusterLabelCache?.get(d.data.data.clusterLabel);\n        if (label) label.node().style.opacity = 1;\n        // Highlight is handled by CSS :hover - no JS needed\n      })\n      .on(\"mouseleave\", function (e, d) {\n        // Label visibility - use cached lookups (O(1))\n        const ratioLimit = self.params.ratioLimit;\n\n        const label1 = self._bigClusterLabelCache?.get(d.data.data.bigClusterLabel);\n        if (label1) {\n          label1.node().style.opacity = label1._cachedRatio >= ratioLimit ? 1 : 0;\n        }\n\n        const label = self._clusterLabelCache?.get(d.data.data.clusterLabel);\n        if (label) {\n          label.node().style.opacity = label._cachedRatio >= ratioLimit ? 1 : 0;\n        }\n        // Highlight is handled by CSS :hover - no JS needed\n      });\n  }\n\n  _drawLabels() {\n    this._drawRegionLabels();\n    this._drawBigClusterLabels();\n    this._drawPercentLabels();\n    this._drawSectorLabels();\n    this._drawPopLabels();\n  }\n\n  _buildLabelCache() {\n    // Build lookup maps for fast label access during hover events\n    this._bigClusterLabelCache = new Map();\n    this._clusterLabelCache = new Map();\n\n    // Cache bigCluster labels with their ratio values\n    this.bigLabelsGroup.selectAll(\"[data-bigCluster]\").nodes().forEach((node) => {\n      const key = node.getAttribute(\"data-bigCluster\");\n      if (key) {\n        const selection = d3.select(node);\n        selection._cachedRatio = parseFloat(node.getAttribute(\"data-ratio\")) || 0;\n        this._bigClusterLabelCache.set(key, selection);\n      }\n    });\n\n    // Cache cluster labels with their ratio values\n    this.labelsGroup.selectAll(\"[data-cluster]\").nodes().forEach((node) => {\n      const key = node.getAttribute(\"data-cluster\");\n      if (key) {\n        const selection = d3.select(node);\n        selection._cachedRatio = parseFloat(node.getAttribute(\"data-ratio\")) || 0;\n        this._clusterLabelCache.set(key, selection);\n      }\n    });\n  }\n\n  _drawRegionLabels() {\n    const { showRegion, regionLabelRenderer } = this.params;\n    const self = this;\n\n    const regionNodes = this.allNodes.filter((d) => d.depth === 1);\n\n    // If custom renderer exists, use foreignObject\n    if (regionLabelRenderer) {\n      this.regionLabelsGroup\n        .selectAll(\"foreignObject\")\n        .data(regionNodes)\n        .enter()\n        .append(\"foreignObject\")\n        .attr(\"class\", \"region-label-foreign\")\n        .attr(\"data-region\", (d) => d.data.key)\n        .attr(\"width\", (d) => {\n          const bounds = VoronoiTreemapHelpers.getPolygonBounds(d.polygon);\n          const width = bounds.maxX - bounds.minX;\n          return width * 0.6;\n        })\n        .attr(\"height\", (d) =>\n          VoronoiTreemapHelpers.estimateLabelHeight(this, d, 1.3)\n        )\n        .attr(\"x\", (d) => {\n          if (!d.polygon?.site) return 0;\n          const bounds = VoronoiTreemapHelpers.getPolygonBounds(d.polygon);\n          const width = bounds.maxX - bounds.minX;\n          return d.polygon.site.x - (width * 0.6) / 2;\n        })\n        .attr(\n          \"y\",\n          (d) => {\n            if (!d.polygon?.site) return 0;\n            return d.polygon.site.y -\n              VoronoiTreemapHelpers.estimateLabelHeight(this, d, 1.3) * 0.4 +\n              VoronoiTreemapHelpers.getLabelHeightOffset(this, d);\n          }\n        )\n        .style(\"opacity\", showRegion ? 1 : 0)\n        .style(\"pointer-events\", \"none\")\n        .style(\"overflow\", \"visible\")\n        .append(\"xhtml:div\")\n        .style(\"width\", \"100%\")\n        .style(\"height\", \"100%\")\n        .style(\"display\", \"flex\")\n        .style(\"align-items\", \"center\")\n        .style(\"justify-content\", \"center\")\n        .html((d) => {\n          const defaultHtml = VoronoiTreemapHelpers.multiline(d.data.key);\n          const context = VoronoiTreemapHelpers.createLabelContext(this, d, 1);\n          return regionLabelRenderer(d, defaultHtml, context);\n        });\n    } else {\n      // Default text rendering\n      this.regionLabelsGroup\n        .selectAll(\"text\")\n        .data(regionNodes)\n        .enter()\n        .append(\"text\")\n        .attr(\"class\", \"region\")\n        .attr(\"text-anchor\", \"start\")\n        .attr(\"ratio\", (d) => d.value / d.parent.value)\n        .style(\n          \"font-size\",\n          (d) =>\n            VoronoiTreemapHelpers.fontScale(this.hierarchy, d) * 1.15 + \"em\"\n        )\n        .style(\"fill-opacity\", showRegion ? 1 : 0)\n        .style(\"stroke-opacity\", showRegion ? 0.85 : 0)\n        .style(\n          \"stroke\",\n          (d) => `${VoronoiTreemapHelpers.getHSLColor(d.color, 0, -0.05, -0.2)}`\n        )\n        .attr(\"paint-order\", \"stroke\")\n        .attr(\n          \"transform\",\n          (d) => {\n            if (!d.polygon?.site) return `translate(0,0)`;\n            return `translate(${[\n              d.polygon.site.x,\n              d.polygon.site.y +\n                VoronoiTreemapHelpers.getLabelHeightOffset(this, d)\n            ]})`;\n          }\n        )\n        .html((d) => VoronoiTreemapHelpers.multiline(d.data.key));\n    }\n  }\n\n  _drawBigClusterLabels() {\n    const { ratioLimit, bigClusterLabelRenderer } = this.params;\n    const self = this;\n\n    const bigClusterNodes = this.allNodes.filter((d) => d.depth === 2);\n\n    // If custom renderer exists, use foreignObject\n    if (bigClusterLabelRenderer) {\n      this.bigLabelsGroup\n        .selectAll(\"foreignObject\")\n        .data(bigClusterNodes)\n        .enter()\n        .append(\"foreignObject\")\n        .attr(\"class\", \"bigcluster-label-foreign\")\n        .attr(\"data-bigCluster\", (d) => d.data.key)\n        .attr(\"data-value\", (d) => d.value)\n        .attr(\"data-ratio\", (d) => d.value / this.totalValue)\n\n        .attr(\"width\", (d) => {\n          const bounds = VoronoiTreemapHelpers.getPolygonBounds(d.polygon);\n          const width = bounds.maxX - bounds.minX;\n          return width * 0.6;\n        })\n        .attr(\"height\", (d) =>\n          VoronoiTreemapHelpers.estimateLabelHeight(this, d, 1.2)\n        )\n        .attr(\"x\", (d) => {\n          if (!d.polygon?.site) return 0;\n          const bounds = VoronoiTreemapHelpers.getPolygonBounds(d.polygon);\n          const width = bounds.maxX - bounds.minX;\n          return d.polygon.site.x - (width * 0.6) / 2;\n        })\n        .attr(\n          \"y\",\n          (d) => {\n            if (!d.polygon?.site) return 0;\n            return d.polygon.site.y -\n              VoronoiTreemapHelpers.estimateLabelHeight(this, d, 1.2) * 0.45 +\n              VoronoiTreemapHelpers.getLabelHeightOffset(this, d);\n          }\n        )\n        .attr(\"opacity\", (d) =>\n          d.value / this.totalValue >= ratioLimit ? 1 : 0\n        )\n        .style(\"pointer-events\", \"none\")\n        .style(\"overflow\", \"visible\")\n        .append(\"xhtml:div\")\n        .style(\"width\", \"100%\")\n        .style(\"height\", \"100%\")\n        .style(\"display\", \"flex\")\n        .style(\"align-items\", \"center\")\n        .style(\"justify-content\", \"center\")\n        .html((d) => {\n          const defaultHtml = VoronoiTreemapHelpers.multiline(d.data.key);\n          const context = VoronoiTreemapHelpers.createLabelContext(this, d, 2);\n          return bigClusterLabelRenderer(d, defaultHtml, context);\n        });\n    } else {\n      // Default text rendering\n      this.bigLabelsGroup\n        .selectAll(\"text\")\n        .data(bigClusterNodes)\n        .enter()\n        .append(\"text\")\n        .attr(\"class\", \"field\")\n        .attr(\"data-bigCluster\", (d) => d.data.key)\n        .attr(\"text-anchor\", \"start\")\n        .attr(\"data-value\", (d) => d.value)\n        .attr(\"data-ratio\", (d) => d.value / this.totalValue)\n        .style(\n          \"font-size\",\n          (d) => VoronoiTreemapHelpers.fontScale(this.hierarchy, d) + \"em\"\n        )\n        .attr(\"paint-order\", \"stroke\")\n        .style(\"fill\", (d) =>\n          VoronoiTreemapHelpers.colorVar2(d.parent.color, 0, 0.2, -0.2)\n        )\n        .attr(\n          \"transform\",\n          (d) => {\n            if (!d.polygon?.site) return `translate(0,0)`;\n            return `translate(${[\n              d.polygon.site.x,\n              d.polygon.site.y +\n                VoronoiTreemapHelpers.getLabelHeightOffset(this, d)\n            ]})`;\n          }\n        )\n        .html((d) => VoronoiTreemapHelpers.multiline(d.data.key))\n        .attr(\"opacity\", (d) =>\n          d.value / this.totalValue >= ratioLimit ? 1 : 0\n        );\n    }\n  }\n\n  _drawPercentLabels() {\n    const { showPercent } = this.params;\n    const percent_label_depth =\n      this.allNodes.filter((d) => d.depth === 1).length > 1 ? 1 : 2;\n\n    this.percentLabelsGroup\n      .selectAll(\"text\")\n      .data(this.allNodes.filter((d) => d.depth === percent_label_depth))\n      .enter()\n      .append(\"text\")\n      .attr(\"class\", (d) => `budget percent label-${d.id}`)\n      .attr(\"text-anchor\", \"middle\")\n      .style(\n        \"font-size\",\n        (d) => VoronoiTreemapHelpers.fontScale(this.hierarchy, d) * 0.8 + \"em\"\n      )\n      .attr(\n        \"transform\",\n        (d) => {\n          if (!d.polygon?.site) return `translate(0,0)`;\n          return `translate(${[\n            d.polygon.site.x,\n            d.polygon.site.y +\n              VoronoiTreemapHelpers.fontScale(this.hierarchy, d) *\n                8 *\n                (VoronoiTreemapHelpers.multiline(d.data.key, true)[1] + 2.2)\n          ]})`;\n        }\n      )\n      .text((d) => \" \" + d3.format(\".0%\")(d.value / this.totalValue))\n      .attr(\"opacity\", (d) =>\n        showPercent\n          ? Math.round((d.value / this.totalValue) * 100) > 0\n            ? 1\n            : 0\n          : 0\n      );\n  }\n\n  _drawSectorLabels() {\n    const { underLabel, ratioLimit } = this.params;\n\n    this.labelsGroup\n      .selectAll(\"text\")\n      .data(this.allNodes.filter((d) => d.depth === 3))\n      .enter()\n      .append(\"text\")\n      .attr(\"class\", (d) => `sector label-${d.id}`)\n      .attr(\"data-cluster\", (d) => d.data.key)\n      .attr(\"data-value\", (d) => d.value)\n      .attr(\"data-ratio\", (d) => d.value / this.totalValue)\n      .attr(\"text-anchor\", \"start\")\n      .style(\n        \"font-size\",\n        (d) => VoronoiTreemapHelpers.fontScale2(this.hierarchy, d) + \"em\"\n      )\n      .style(\"fill\", (d) =>\n        VoronoiTreemapHelpers.getHSLColor(d.color, 0, -0.1, -0.3)\n      )\n      .attr(\"transform\", (d) => {\n        if (!d.polygon?.site) return `translate(0,0)`;\n        return underLabel\n          ? `translate(${[\n              d.polygon.site.x,\n              d.polygon.site.y +\n                VoronoiTreemapHelpers.fontScale1(\n                  this.hierarchy,\n                  d.data.data.bigClusterLabel,\n                  d.parent.value\n                ) *\n                  8 *\n                  (VoronoiTreemapHelpers.multiline(\n                    d.data.data.bigClusterLabel,\n                    true\n                  )[1] +\n                    0.5)\n            ]})`\n          : `translate(${VoronoiTreemapHelpers.getLabelPos(this, d)})`;\n      })\n      .html((d) => VoronoiTreemapHelpers.multiline(d.data.key))\n      .attr(\"opacity\", (d) => (d.value / this.totalValue > ratioLimit ? 1 : 0));\n  }\n\n  _drawPopLabels() {\n    const { sizeLimit } = this.params;\n\n    this.popLabelsGroup\n      .selectAll(\"text\")\n      .data(this.allNodes.filter((d) => d.depth === 3))\n      .enter()\n      .append(\"text\")\n      .attr(\"class\", (d) => `budget label-${d.id}`)\n      .attr(\"text-anchor\", \"middle\")\n      .style(\n        \"font-size\",\n        (d) => VoronoiTreemapHelpers.fontScale2(this.hierarchy, d) * 0.8 + \"em\"\n      )\n      .attr(\n        \"data-pop\",\n        (d) => d.data.data.clusterLabel ?? d.data.data.bigClusterLabel\n      )\n      .attr(\n        \"transform\",\n        (d) => {\n          if (!d.polygon?.site) return `translate(0,0)`;\n          return `translate(${[\n            d.polygon.site.x,\n            d.polygon.site.y + VoronoiTreemapHelpers.varFontScale(this, d)\n          ]})`;\n        }\n      )\n      .text((d) => VoronoiTreemapHelpers.bigFormat(d.data.values[0].size))\n      .attr(\"opacity\", (d) => (d.value > sizeLimit ? 1 : 0));\n  }\n\n  // === 4. Post-processing and Effects Methods ===\n\n  _applyPostEffects() {\n    const { showRegion, pebbleRound, pebbleWidth } = this.params;\n\n    if (showRegion) {\n      this.labelAdjuster.adjust(this.svg.node(), { verticalSpacing: 0 });\n    }\n\n    this.pebbleRenderer.render(\n      this.svg.node(),\n      pebbleRound,\n      pebbleWidth,\n      VoronoiTreemapHelpers.colorVar.bind(VoronoiTreemapHelpers)\n    );\n  }\n}\n\nexport default VoronoiTreemap;\n","/**\n * Voronoi Popup Utility\n *\n * Displays a popup/tooltip for clicked voronoi cells.\n * Handles positioning, template formatting, and cleanup.\n */\n\n/**\n * Show a popup for a clicked voronoi cell\n *\n * @param {Object} clicked - The clicked cell data object\n * @param {Object} clicked.clickArea - D3 selection of the clicked path\n * @param {string} clicked.key - The key/label of the clicked cell\n * @param {Object} [clicked.data] - Additional data associated with the cell\n * @param {Object} [options] - Popup configuration options\n * @param {string} [options.format=\"{text}\"] - Template string for popup content (e.g., \"{key}: {value}\")\n * @param {string} [options.popupId=\"voronoi-popup\"] - DOM ID for the popup element\n * @param {string} [options.className=\"voronoi-popup-container\"] - CSS class for the popup\n * @param {Function} [options.onClose] - Callback function when popup is closed\n * @returns {HTMLElement|undefined} The created popup element, or undefined if no popup was created\n */\nexport default function showVoronoiPopup(clicked, options = {}) {\n  const {\n    format = \"{text}\",\n    popupId = \"voronoi-popup\",\n    className = \"voronoi-popup-container\",\n    onClose = null\n  } = options;\n\n  // Remove existing popup\n  const existingPopup = document.getElementById(popupId);\n  if (existingPopup) existingPopup.remove();\n\n  // Exit if no clicked data\n  if (!clicked || !clicked.clickArea) {\n    if (onClose) onClose();\n    return;\n  }\n\n  const clickedPath = clicked.clickArea.node();\n  const svgElement = clickedPath.ownerSVGElement;\n  if (!svgElement) return;\n\n  // === Calculate position in page coordinates (unaffected by container zoom) ===\n  // Get the path's bounding box in SVG coordinate space\n  const pathBBox = clickedPath.getBBox();\n\n  // Calculate cell center in SVG coordinates\n  const svgCenterX = pathBBox.x + pathBBox.width / 2;\n  const svgCenterY = pathBBox.y + pathBBox.height / 2;\n\n  // Convert SVG coordinates to screen (page) coordinates\n  // This handles all transformations including zoom, scale, translate\n  const svgPoint = svgElement.createSVGPoint();\n  svgPoint.x = svgCenterX;\n  svgPoint.y = svgCenterY;\n  const screenPoint = svgPoint.matrixTransform(svgElement.getScreenCTM());\n\n  // Use screen coordinates directly (relative to viewport)\n  const x = screenPoint.x + window.scrollX;\n  const y = screenPoint.y + window.scrollY;\n\n  // Determine popup direction based on available space\n  const spaceAbove = screenPoint.y;\n  const spaceBelow = window.innerHeight - screenPoint.y;\n  const placeBelow = spaceAbove < 150 || spaceBelow > spaceAbove;\n\n  // === Template substitution ===\n  const data = {\n    key: clicked.key,\n    ...(clicked.data || {}),\n    ...(clicked.data?.data || {}),\n    ...(clicked.d?.data?.data || {})\n  };\n\n  let content = format\n    .replace(/\\{(\\w+)\\}/g, (match, field) => {\n      const val = data[field];\n      return val !== undefined && val !== null ? String(val) : match;\n    })\n    .replace(/\\\\n/g, \"<br>\")\n    .replace(/\\n/g, \"<br>\");\n\n  // === Create popup ===\n  const popup = document.createElement(\"div\");\n  popup.id = popupId;\n  popup.className = className;\n\n  Object.assign(popup.style, {\n    position: \"absolute\",\n    left: \"-9999px\", // Render off-screen for size measurement\n    top: \"0px\",\n    zIndex: \"1000\"\n  });\n  popup.classList.add(placeBelow ? \"popup-below\" : \"popup-above\");\n\n  popup.innerHTML = `<div class=\"voronoi-popup-content\">\n    <div class=\"voronoi-popup-message\">${content}</div>\n  </div>`;\n\n  // Append to body (not container) to avoid zoom/transform effects\n  document.body.appendChild(popup);\n\n  // Measure size using offsetWidth/offsetHeight (synchronous)\n  const popupWidth = popup.offsetWidth;\n  const popupHeight = popup.offsetHeight;\n\n  // Calculate horizontal position with boundary check\n  let finalX = x - popupWidth / 2;\n  const padding = 10; // Minimum padding from edges\n\n  // Keep popup within viewport bounds (horizontal)\n  if (finalX < padding) {\n    finalX = padding;\n  } else if (finalX + popupWidth > window.innerWidth - padding) {\n    finalX = window.innerWidth - popupWidth - padding;\n  }\n\n  // Calculate vertical position\n  const finalY = placeBelow ? y + 5 : y - 5 - popupHeight;\n\n  // Set final position (fixed to page, not container)\n  popup.style.left = `${finalX}px`;\n  popup.style.top = `${finalY}px`;\n\n  // === Outside click/touch handler (mobile-friendly) ===\n  const handler = (e) => {\n    if (!popup.contains(e.target) && !svgElement.contains(e.target)) {\n      popup.remove();\n      document.removeEventListener(\"click\", handler);\n      document.removeEventListener(\"touchstart\", handler);\n      const clickedCell = svgElement.querySelector(\"path.clicked\");\n      if (clickedCell) clickedCell.classList.remove(\"clicked\");\n      if (onClose) onClose();\n    }\n  };\n  setTimeout(() => {\n    document.addEventListener(\"click\", handler);\n    document.addEventListener(\"touchstart\", handler); // Mobile support\n  }, 10);\n\n  return popup;\n}\n"],"names":["d3","Object","assign","d3Core","d3WeightedVoronoi","d3VoronoiMap","d3VoronoiTreemap","seedrandom","seedrandomModule","default","PebbleRenderer","constructor","d3Instance","this","render","treemap","round","width","colorVarFunc","cell","select","empty","chartGroup","node","parentNode","remove","outlineGroup","insert","attr","outlineGroup2","_renderDepth2Outlines","_renderDepth1Outlines","self","selectAll","each","datum","path","polygon","cellColor","parent","color","_defaultColorVar","style","length","originalPath","map","p","join","smoothedPath","smoothPath","append","pathData","cornerRadius","minDistanceThreshold","rawPoints","replace","split","d","trim","Number","filter","x","y","isNaN","simplifiedPoints","_simplifyPoints","n","newPath","i","p0","p1","p2","vIn","vOut","lenIn","Math","hypot","lenOut","inNorm","outNorm","dot","angle","acos","max","min","adjustedRadius","PI","halfAngle","maxRadiusByLength","tan","pStart","pEnd","tempPoints","lastPoint","currentPoint","push","firstPoint","lastAddedPoint","pop","h","l","s","c","hsl","formatHex","LabelAdjuster","adjust","options","verticalSpacing","delay","checkOverlap","box1","box2","margin","height","getLabelBox","element","bbox","getBBox","tspanCount","size","transform","match","parseFloat","parseTransform","originalX","originalY","getCellBounds","data","xs","ys","minX","maxX","minY","maxY","findMinimumMove","labelBox","parentBox","cellBounds","box1Top","box1Bottom","box2Top","box2Bottom","getRequiredMoveDistance","originallyAbove","newY","proposedY","setTimeout","svg","fieldLabel","parentRegionElement","key","nodes","regionLabel","fieldBox","regionBox","regionKey","String","newPos","adjustFieldLabel","sectorLabel","parentFieldElement","sectorBox","adjustSectorLabel","nestingForVoronoi","key1","key2","simpleData","region","bubbleSize","nested","rollups","sum","v","makeDictionary","bc","bcData","k","item","originalData","values","raw","regionData","VoronoiTreemapHelpers","fontScale","hierarchy","ratio","value","scaleLog","domain","range","fontScale1","string","fontScale2","varFontScale","text","clusterLabel","bigClusterLabel","cols","rows","multiline","getHSLColor","hslColor","copy","colorVar","colorVar2","colorvariation","vdomain","desc","extent","vScale","scaleLinear","colorHierarchy","depth","regionColor","children","params","colorFunc","parentColor","siblings","forEach","child","getBoxInfo","inputText","isLatinText","test","forcedLineBreaks","allLines","line","words","currentLines","count","lineCount","word","filteredLines","concat","charWidths","j","t","f","r","I","w","W","m","M","a","e","o","u","A","E","O","U","N","S","lineWidths","trimmedLine","Array","from","reduce","char","calculateTextWidth","maxLength","html","getLabelHeightOffset","fontSize","lineRows","getLabelPos","site","parentCenter","currentCenter","diffX","diffY","offY","offX","meanWidth","boxHeight","boxWidth","minOffset","abs","parentBounds","getPolygonBounds","proposedX","point","estimatePolygonRadius","originalObject","area","sqrt","estimateLabelWidth","fontMultiplier","maxWidth","estimateLabelHeight","createLabelContext","totalValue","percentText","format","darkerColor","lighterColor","centerX","centerY","formatNumber","bigFormat","formatPercent","floor","parseInt","createCustomVoronoiAlgorithm","debug","DEFAULT_PRNG","random","clip","convergenceRatio","maxIterationCount","minWeightRatio","prng","initialPositions","_convenientReusableVoronoiMapSimulation","voronoiMapSimulation","weight","stop","helpers","_voronoiTreemap","rootNode","recurse","_","arguments","clippingPolygon","simulation","state","initialPosition","createInitialPositioner","ended","tick","polygons","cp","dx","dy","findNodeInitialPosition","find","pos","arr","shouldUpdateInternals","siblingInitialPositions","sibling","undefined","getSiblingInitialPositions","siblingXExtent","siblingYExtent","nodeInitialPosition","polygonContains","mappedX","mappedY","polygonAngles","atan2","normalizedAngle","startAngle","endAngle","startPoint","endPoint","edgeX","edgeY","polygonXExtent","polygonYExtent","mapPointToPolygon","sort","b","getPolygonAngles","createDOMPopup","clickedData","existingPopup","document","querySelector","event","popup","createElement","className","pageX","pageY","left","top","content","innerHTML","appendChild","body","closeHandler","contains","target","removeEventListener","addEventListener","getBubbleStyles","VoronoiTreemap","right","bottom","allNodes","_pebbleRenderer","_labelAdjuster","DEFAULT_COLORS","DEFAULT_OPTIONS","maptitle","caption","clickFunc","getCellColors","sizeLimit","ratioLimit","pieSize","colors","seedRandom","showRegion","showPercent","underLabel","regionPositions","forceNodeFunc","pebbleRound","pebbleWidth","regionColors","regionLabelRenderer","bigClusterLabelRenderer","pebbleRenderer","labelAdjuster","_setupSVG","_prepareData","_setupGroups","_drawTitleAndCaption","_createRegionColorScale","_computeLayout","_drawCells","_drawLabels","_buildLabelCache","_applyPostEffects","update","newData","create","voronoiGroup","labelsGroup","popLabelsGroup","bigLabelsGroup","percentLabelsGroup","regionLabelsGroup","regionSizes","rollup","sortedRegions","entries","paletteColors","customColorMap","Map","colorMapping","scaleOrdinal","keys","ellipse","cos","sin","seed","voronoiTreemap","voronoiTreeMap","mergedPositions","_normalizePositions","modifiedVoronoiTreeMap","descendants","id","cellColors","_extractCellColors","result","hierarchyNodes","addJitterForDuplicates","positions","jitterAmount","positionMap","toFixed","get","jitter","set","depth1","xExtent","yExtent","xScale","yScale","depth1Normalized","depthPositions","nodesAtDepth","group","parentKey","siblingKeys","Set","siblingPositions","has","siblingNormalized","enter","on","clicked","classed","clickArea","label1","_bigClusterLabelCache","opacity","label","_clusterLabelCache","_cachedRatio","_drawRegionLabels","_drawBigClusterLabels","_drawPercentLabels","_drawSectorLabels","_drawPopLabels","getAttribute","selection","regionNodes","bounds","defaultHtml","context","bigClusterNodes","percent_label_depth","bind","popupId","onClose","getElementById","clickedPath","svgElement","ownerSVGElement","pathBBox","svgCenterX","svgCenterY","svgPoint","createSVGPoint","screenPoint","matrixTransform","getScreenCTM","window","scrollX","scrollY","spaceAbove","spaceBelow","innerHeight","placeBelow","field","val","position","zIndex","classList","add","popupWidth","offsetWidth","popupHeight","offsetHeight","finalX","innerWidth","finalY","handler","clickedCell"],"mappings":"ixBA6BA,MAAMA,EAAKC,OAAOC,OAChB,CAAA,EACAC,EACAC,EACAC,EACAC,GAKFN,EAAGO,WAAaC,EAAiBC,SAAWD,EClBrC,MAAME,EAKX,WAAAC,CAAYC,GACVC,KAAKb,GAAKY,GAAcZ,CAC1B,CASA,MAAAc,CAAOC,EAASC,EAAQ,GAAIC,EAAQ,EAAGC,GACrC,MACMC,EADYN,KAAKb,GAAGoB,OAAOL,GACVK,OAAO,UAE9B,GAAID,EAAKE,QACP,OAGF,MAAMC,EAAaT,KAAKb,GAAGoB,OAAOD,EAAKI,OAAOC,YAE9CF,EAAWF,OAAO,iBAAiBK,SACnCH,EAAWF,OAAO,kBAAkBK,SAEpC,MAAMC,EAAeJ,EAClBK,OAAO,IAAK,cACZC,KAAK,QAAS,gBAEXC,EAAgBP,EACnBK,OAAO,IAAK,cACZC,KAAK,QAAS,gBACdA,KAAK,KAAM,YAEdf,KAAKiB,sBAAsBX,EAAMU,EAAeX,GAChDL,KAAKkB,sBAAsBZ,EAAMO,EAAcV,EAAOC,EACxD,CASA,qBAAAa,CAAsBX,EAAMO,EAAcR,GACxC,MAAMc,EAAOnB,KAEbM,EAAKc,UAAU,gBAAgBC,KAAK,SAAUC,GAC5C,MAAMC,EAAOJ,EAAKhC,GAAGoB,OAAOP,MACtBwB,EAAUF,EAAME,QAEhBC,EAAYpB,EACdA,EAAaiB,EAAMI,OAAOC,MAAO,GAAG,IAAM,KAC1CR,EAAKS,iBAAiBN,EAAMI,OAAOC,MAAO,GAAG,SAIjD,GAFAJ,EAAKM,MAAM,SAAUJ,GAEjBD,GAAWA,EAAQM,OAAS,EAAG,CACjC,MAAMC,EACJ,IAAMP,EAAQQ,IAAKC,GAAM,GAAGA,EAAE,MAAMA,EAAE,MAAMC,KAAK,KAAO,IACpDC,EAAehB,EAAKiB,WAAWL,EAAc,EAAG,GAEtDlB,EACGwB,OAAO,QACPtB,KAAK,IAAK,GAAGgB,KAAgBI,KAC7BpB,KAAK,OAAQU,GACbV,KAAK,SAAUU,GACfV,KAAK,eAAgB,GACrBc,MAAM,YAAa,UACxB,CACF,EACF,CAUA,qBAAAX,CAAsBZ,EAAMO,EAAcV,EAAOC,GAC/C,MAAMe,EAAOnB,KAEbM,EAAKc,UAAU,gBAAgBC,KAAK,SAAUC,GAC5C,MAAME,EAAUF,EAAME,QAEtB,GAAIA,GAAWA,EAAQM,OAAS,EAAG,CACjC,MAAMC,EACJ,IAAMP,EAAQQ,IAAKC,GAAM,GAAGA,EAAE,MAAMA,EAAE,MAAMC,KAAK,KAAO,IACpDC,EAAehB,EAAKiB,WAAWL,EAAc5B,GAEnDU,EACGwB,OAAO,QACPtB,KAAK,IAAK,GAAGgB,KAAgBI,KAC7BpB,KAAK,OAAQ,QACbA,KAAK,SAAU,QACfA,KAAK,eAAgBX,GACrByB,MAAM,YAAa,UACxB,CACF,EACF,CASA,UAAAO,CAAWE,EAAUC,EAAe,GAAIC,EAAuB,GAC7D,MAAMC,EAAYH,EACfI,QAAQ,SAAU,IAClBC,MAAM,KACNX,IAAKY,GAAMA,EAAEC,OAAOF,MAAM,KAAKX,IAAIc,SACnCC,OAAO,EAAEC,EAAGC,MAAQC,MAAMF,KAAOE,MAAMD,IAE1C,GAAIR,EAAUX,OAAS,EAAG,OAAOQ,EAEjC,IAAIa,EAAmBnD,KAAKoD,gBAAgBX,EAAWD,GAEvD,GAAIW,EAAiBrB,OAAS,EAAG,OAAOQ,EAExC,MAAMe,EAAIF,EAAiBrB,OAC3B,IAAIwB,EAAU,GAEd,IAAK,IAAIC,EAAI,EAAGA,EAAIF,EAAGE,IAAK,CAC1B,MAAMC,EAAKL,GAAkBI,EAAI,EAAIF,GAAKA,GACpCI,EAAKN,EAAiBI,GACtBG,EAAKP,GAAkBI,EAAI,GAAKF,GAEhCM,EAAM,CAAEX,EAAGQ,EAAG,GAAKC,EAAG,GAAIR,EAAGO,EAAG,GAAKC,EAAG,IACxCG,EAAO,CAAEZ,EAAGU,EAAG,GAAKD,EAAG,GAAIR,EAAGS,EAAG,GAAKD,EAAG,IACzCI,EAAQC,KAAKC,MAAMJ,EAAIX,EAAGW,EAAIV,GAC9Be,EAASF,KAAKC,MAAMH,EAAKZ,EAAGY,EAAKX,GAEvC,GAAIY,EAAQ,MAAQG,EAAS,KAAM,SAEnC,MAAMC,EAAS,CAAEjB,EAAGW,EAAIX,EAAIa,EAAOZ,EAAGU,EAAIV,EAAIY,GACxCK,EAAU,CAAElB,EAAGY,EAAKZ,EAAIgB,EAAQf,EAAGW,EAAKX,EAAIe,GAE5CG,EAAMF,EAAOjB,EAAIkB,EAAQlB,EAAIiB,EAAOhB,EAAIiB,EAAQjB,EACtD,IAAImB,EAAQN,KAAKO,KAAKP,KAAKQ,OAAQR,KAAKS,IAAI,EAAGJ,KAE/C,MAAMK,EACJJ,EAAQN,KAAKW,GAAK,IAAMlC,EAAe,EAAIA,EACvCmC,EAAYN,EAAQ,EACpBO,EAAoBb,KAAKS,IAAIV,EAAOG,GAAU,IAC9CpB,EAAIkB,KAAKS,IACbV,EACAG,EACAQ,EAAiBV,KAAKc,IAAIF,GAC1BC,EAAoBb,KAAKc,IAAIF,IAGzBG,EAAS,CAACpB,EAAG,GAAKQ,EAAOjB,EAAIJ,EAAGa,EAAG,GAAKQ,EAAOhB,EAAIL,GACnDkC,EAAO,CAACrB,EAAG,GAAKS,EAAQlB,EAAIJ,EAAGa,EAAG,GAAKS,EAAQjB,EAAIL,GAEzDU,GACQ,IAANC,EACI,IAAIsB,EAAO,MAAMA,EAAO,KACxB,KAAKA,EAAO,MAAMA,EAAO,KAC/BvB,GAAW,KAAKG,EAAG,MAAMA,EAAG,MAAMqB,EAAK,MAAMA,EAAK,IACpD,CAGA,OADAxB,GAAW,IACJA,CACT,CASA,eAAAF,CAAgBX,EAAWD,GACzB,GAAIA,GAAwB,GAAKC,EAAUX,QAAU,EACnD,OAAOW,EAGT,MAAMsC,EAAa,CAACtC,EAAU,IAC9B,IAAIuC,EAAYvC,EAAU,GAE1B,IAAK,IAAIc,EAAI,EAAGA,EAAId,EAAUX,OAAQyB,IAAK,CACzC,MAAM0B,EAAexC,EAAUc,GAClBO,KAAKC,MAChBkB,EAAa,GAAKD,EAAU,GAC5BC,EAAa,GAAKD,EAAU,KAGlBxC,IACVuC,EAAWG,KAAKD,GAChBD,EAAYC,EAEhB,CAEA,MAAME,EAAaJ,EAAW,GACxBK,EAAiBL,EAAWA,EAAWjD,OAAS,GACtD,GAAIsD,IAAmBD,EAAY,CACpBrB,KAAKC,MAChBoB,EAAW,GAAKC,EAAe,GAC/BD,EAAW,GAAKC,EAAe,IAEtB5C,GACTuC,EAAWM,KAEf,CAEA,OAAON,EAAWjD,QAAU,EAAIiD,EAAatC,CAC/C,CAWA,gBAAAb,CAAiBD,EAAO2D,EAAI,EAAGC,EAAI,EAAGC,EAAI,GACxC,IAAIC,EAAIzF,KAAKb,GAAGuG,IAAI/D,GAKpB,OAJA8D,EAAEH,GAAKA,EACPG,EAAEF,GAAKA,EACPE,EAAED,GAAKA,EACHC,EAAEF,EAAI,MAAME,EAAEF,EAAI,KACfE,EAAEE,WACX,ECzOK,MAAMC,EAKX,WAAA9F,CAAYC,GACVC,KAAKb,GAAKY,GAAcZ,CAC1B,CASA,MAAA0G,CAAO3F,EAAS4F,EAAU,IACxB,MAAMC,gBAAEA,EAAkB,EAACC,MAAEA,EAAQ,KAAQF,EACvC3G,EAAKa,KAAKb,GAgChB,SAAS8G,EAAaC,EAAMC,GAC1B,MAAMC,EAASL,EAAkB,EAEjC,QACEG,EAAKlD,EAAIkD,EAAK9F,MAAQ,GAFR,EAEsB+F,EAAKnD,EAAImD,EAAK/F,MAAQ,GAC1D8F,EAAKlD,EAAIkD,EAAK9F,MAAQ,IAHR,EAGsB+F,EAAKnD,EAAImD,EAAK/F,MAAQ,GAC1D8F,EAAKjD,EAAIiD,EAAKG,OAAS,EAAID,EAASD,EAAKlD,EAAIkD,EAAKE,OAAS,GAC3DH,EAAKjD,EAAIiD,EAAKG,OAAS,EAAID,EAASD,EAAKlD,EAAIkD,EAAKE,OAAS,EAE/D,CAyBA,SAASC,EAAYC,GACnB,MAAM7F,EAAO6F,EAAQ7F,OACrB,IAAKA,EAAM,OAAO,KAElB,MAAM8F,EAAO9F,EAAK+F,UAClB,IAAIrG,MAAEA,EAAKiG,OAAEA,GAAWG,EACxB,MAAME,EAAaH,EAAQnF,UAAU,eAAeuF,QAAU,EACxDC,EAtDR,SAAwBA,GACtB,IAAKA,EAAW,MAAO,CAAE5D,EAAG,EAAGC,EAAG,GAClC,MAAM4D,EAAQD,EAAUC,MAAM,gCAC9B,OAAKA,EACE,CAAE7D,EAAG8D,WAAWD,EAAM,IAAK5D,EAAG6D,WAAWD,EAAM,KADnC,CAAE7D,EAAG,EAAGC,EAAG,EAEhC,CAiDoB8D,CAAeR,EAAQxF,KAAK,cAE9C,MAAO,CACLiG,UAAWJ,EAAU5D,EACrBiE,UAAWL,EAAU3D,EACrBD,EAAG4D,EAAU5D,EAAI5C,EAAQ,EACzB6C,EAAG2D,EAAU3D,EAAIoD,EAAS,EAC1BjG,QACAiG,SACAK,aAEJ,CAOA,SAASQ,EAAcC,GACrB,IAAKA,IAASA,EAAK3F,QAAS,OAAO,KACnC,MAAM4F,EAAKD,EAAK3F,QAAQQ,IAAKC,GAAMA,EAAE,IAC/BoF,EAAKF,EAAK3F,QAAQQ,IAAKC,GAAMA,EAAE,IACrC,MAAO,CACLqF,KAAMxD,KAAKS,OAAO6C,GAClBG,KAAMzD,KAAKQ,OAAO8C,GAClBI,KAAM1D,KAAKS,OAAO8C,GAClBI,KAAM3D,KAAKQ,OAAO+C,GAEtB,CASA,SAASK,EAAgBC,EAAUC,EAAWC,GAC5C,GACEF,EAAS3E,EAAI2E,EAASvH,MAAQ,EAAIwH,EAAU5E,EAAI4E,EAAUxH,MAAQ,GAClEuH,EAAS3E,EAAI2E,EAASvH,MAAQ,EAAIwH,EAAU5E,EAAI4E,EAAUxH,MAAQ,EAElE,MAAO,CAAE4C,EAAG2E,EAASX,UAAW/D,EAAG0E,EAASV,WAI9C,GAAqB,IAtEvB,SAAiCf,EAAMC,GACrC,MAAMC,EAASL,EAAkB,EAC3B+B,EAAU5B,EAAKjD,EAAIiD,EAAKG,OAAS,EAAID,EACrC2B,EAAa7B,EAAKjD,EAAIiD,EAAKG,OAAS,EAAID,EACxC4B,EAAU7B,EAAKlD,EAAIkD,EAAKE,OAAS,EAAID,EACrC6B,EAAa9B,EAAKlD,EAAIkD,EAAKE,OAAS,EAAID,EAE9C,OAAI2B,GAAcC,GAAWF,GAAWG,EAAmB,EACvD/B,EAAKjD,EAAIkD,EAAKlD,EAAU8E,EAAaC,EAClCC,EAAaH,CACtB,CA2DuBI,CAAwBP,EAAUC,GAErD,MAAO,CAAE5E,EAAG2E,EAASX,UAAW/D,EAAG0E,EAASV,WAG9C,MAAMkB,EAAkBR,EAAS1E,EAAI2E,EAAU3E,EAC/C,IAAImF,EAAOT,EAAS1E,EAEpB,GAAIkF,EAAiB,CACnB,MAAME,EACJT,EAAUX,UACVU,EAAStB,QACRsB,EAASjB,WAAa,EACnBiB,EAAStB,QAAUsB,EAASjB,WAAa,GAAK,EAC9C,GACF2B,GAAaR,EAAWL,OAAMY,EAAOC,EAC3C,KAAO,CACL,MAAMA,EACJT,EAAUX,UACVW,EAAUvB,QACTsB,EAASjB,WAAa,EACnBiB,EAAStB,QAAUsB,EAASjB,WAAa,GAAK,EAC9C,GACF2B,EAAYV,EAAStB,QAAUwB,EAAWJ,OAAMW,EAAOC,EAC7D,CAEA,MAAO,CAAErF,EAAG2E,EAASX,UAAW/D,EAAGmF,EACrC,CA/IAE,WAAW,KACT,MAAMC,EAAMpJ,EAAGoB,OAAOL,GAEtBqI,EAAInH,UAAU,UAAUC,KAAK,YAyL/B,SAA0BmH,GACxB,MAAMrB,EAAOqB,EAAWlH,QACxB,IAAK6F,IAASA,EAAKzF,OAAQ,OAE3B,MAAM+G,EAAsBtJ,EACzBoB,OAAOL,GACPkB,UAAU,WACV2B,OAAQH,GAAMA,GAAGuE,MAAMuB,MAAQvB,EAAKzF,QAAQyF,MAAMuB,KAClDC,QAAQ,GAEX,IAAKF,EAAqB,OAE1B,MAAMG,EAAczJ,EAAGoB,OAAOkI,GACxBI,EAAWvC,EAAYkC,GACvBM,EAAYxC,EAAYsC,GACxBf,EAAaX,EAAcC,GAEjC,IACGU,IACAgB,IACAC,GACkB,IAAnBD,EAASzI,OACW,IAApByI,EAASxC,QACW,IAApByC,EAAU1I,OACW,IAArB0I,EAAUzC,OAEV,OAGF,MAAM0C,EAAYH,EAAYtH,SAAS6F,MAAMuB,IAC7C,GACEK,GACAC,OAAOD,GAAWlC,MAAM,SACxBZ,EAAa4C,EAAUC,GACvB,CACA,MAAMG,EAASvB,EAAgBmB,EAAUC,EAAWjB,GACpDW,EAAWzH,KAAK,YAAa,aAAakI,EAAOjG,KAAKiG,EAAOhG,KAC/D,CACF,CA9NIiG,CAAiB/J,EAAGoB,OAAOP,MAC7B,GAEAuI,EAAInH,UAAU,WAAWC,KAAK,YA8IhC,SAA2B8H,GACzB,MAAMhC,EAAOgC,EAAY7H,QACzB,IAAK6F,IAASA,EAAKzF,OAAQ,OAE3B,MAAM0H,EAAqBjK,EACxBoB,OAAOL,GACPkB,UAAU,UACV2B,OAAQH,GAAMA,GAAGuE,MAAMuB,MAAQvB,EAAKzF,QAAQyF,MAAMuB,KAClDC,QAAQ,GAEX,IAAKS,EAAoB,OAEzB,MAAMZ,EAAarJ,EAAGoB,OAAO6I,GACvBC,EAAY/C,EAAY6C,GACxBN,EAAWvC,EAAYkC,GACvBX,EAAaX,EAAcC,GAEjC,IACGU,IACAwB,IACAR,GACmB,IAApBQ,EAAUjJ,OACW,IAArBiJ,EAAUhD,QACS,IAAnBwC,EAASzI,OACW,IAApByI,EAASxC,OAET,OAGF,GAAIJ,EAAaoD,EAAWR,GAAW,CACrC,MAAMI,EAASvB,EAAgB2B,EAAWR,EAAUhB,GACpDsB,EAAYpI,KAAK,YAAa,aAAakI,EAAOjG,KAAKiG,EAAOhG,KAChE,CACF,CA9KIqG,CAAkBnK,EAAGoB,OAAOP,MAC9B,IACCgG,EAyNL,EChPK,SAASuD,EACdpC,EACAqC,EAAO,kBACPC,EAAO,gBAGP,MAAMC,EAAavC,EAAKnF,IAAKY,IAAC,CAC5B4G,CAACA,GAAO5G,EAAE4G,GACVC,CAACA,GAAO7G,EAAE6G,GACVE,OAAQ/G,EAAE+G,OACVhD,KAAM/D,EAAEgH,YAAc,KAIlBC,EAAS1K,EAAG2K,QAChBJ,EACC9G,GAAMzD,EAAG4K,IAAInH,EAAEZ,IAAKgI,GAAMA,EAAErD,OAC5B/D,GAAMA,EAAE+G,OACR/G,GAAMA,EAAE4G,GACR5G,GAAMA,EAAE6G,IAILQ,EAAiB,CAACC,EAAIC,EAAQR,IAC3BQ,EAAOnI,IAAKoI,IACjB,MAAMC,EAAO,CACXb,CAACA,GAAOU,EACRT,CAACA,GAAOW,EAAE,GACVzD,KAAMyD,EAAE,GAAKA,EAAE,GAAK,GAGhBE,EAAenD,EAAKpE,OACvB0C,GACCA,EAAEkE,SAAWA,GACblE,EAAE+D,KAAUa,EAAKb,IACjB/D,EAAEgE,KAAUY,EAAKZ,IAGrB,MAAO,CACLf,IAAK0B,EAAE,GACPG,OAAQ,CAACF,GACTlD,KAAMmD,EAAa,GACnBE,IAAKF,KAcX,MAAO,CACL5B,IAAK,YACL6B,OAVSV,EAAO7H,IAAI,EAAE2H,EAAQc,MAAW,CACzC/B,IAAKiB,EACLY,OAAQE,EAAWzI,IAAI,EAAEkI,EAAIC,MAAO,CAClCzB,IAAKwB,EACLK,OAAQN,EAAeC,EAAIC,EAAQR,SAM1B5G,OAAQH,GAAMA,EAAE8F,KAE/B,CCpEK,MAACgC,EAAwB,CAS5BC,UAAW,SAAUC,EAAWhI,GAC9B,IAAIiI,EAASjI,EAAEkI,MAAQF,EAAUE,MAAS,IAG1C,OAFID,EAAQ,KAAIA,EAAQ,IACpBA,EAAQ,KAAKA,EAAQ,IAClB1L,EAAG4L,WAAWC,OAAO,CAAC,GAAK,KAAKC,MAAM,CAAC,GAAK,KAA5C9L,CAAkD0L,EAC3D,EASAK,WAAY,SAAUN,EAAWO,EAAQL,GACvC,IAAID,EAASC,EAAQF,EAAUE,MAAS,IAGxC,OAFID,EAAQ,KAAIA,EAAQ,IACpBA,EAAQ,KAAKA,EAAQ,IAClB1L,EAAG4L,WAAWC,OAAO,CAAC,GAAK,KAAKC,MAAM,CAAC,GAAK,KAA5C9L,CAAkD0L,EAC3D,EAQAO,WAAY,SAAUR,EAAWhI,GAC/B,IAAIiI,EAASjI,EAAEkI,MAAQF,EAAUE,MAAS,IAG1C,OAFID,EAAQ,IAAGA,EAAQ,GACnBA,EAAQ,KAAKA,EAAQ,IAClB1L,EAAG4L,WAAWC,OAAO,CAAC,GAAK,IAAIC,MAAM,CAAC,GAAK,IAA3C9L,CAAiD0L,EAC1D,EAQAQ,aAAc,SAAUlK,EAAMyB,GAC5B,MAAM0I,EAAO1I,EAAEuE,KAAKA,KAAKoE,cAAgB3I,EAAEuE,KAAKA,KAAKqE,iBAC9CC,EAAMC,GAAQ1L,KAAK2L,UAAUL,GAAM,GAC1C,OAAO1I,EAAEuE,KAAKA,KAAKoE,aACuB,EAArCvL,KAAKoL,WAAWjK,EAAKyJ,UAAWhI,GAAS8I,EAAQ,EAAI,GACjB,GAApC1L,KAAK2K,UAAUxJ,EAAKyJ,UAAWhI,GAAU8I,EAAQ,EAAI,CAC5D,EAYAE,YAAa,SAAUjK,EAAO2D,EAAGE,EAAGD,GAClCD,EAAIA,GAAK,EACTE,EAAIA,GAAK,EACTD,EAAIA,GAAK,EACT,MAAMsG,EAAW1M,EAAGuG,IAAI/D,GAMxB,OALqBkK,EAASC,KAAK,CACjCxG,EAAGuG,EAASvG,EAAIA,EAChBE,EAAGqG,EAASrG,EAAIA,EAChBD,EAAGsG,EAAStG,EAAIA,IAEEI,WACtB,EAUAoG,SAAU,SAAUpK,EAAO2D,EAAGC,EAAGC,GAC/BF,EAAIA,GAAK,EACTC,EAAIA,GAAK,EACTC,EAAIA,GAAK,EACT,IAAIC,EAAItG,EAAGuG,IAAI/D,GAKf,OAJA8D,EAAEH,GAAKA,EACPG,EAAEF,GAAKA,EACPE,EAAED,GAAKA,EACHC,EAAEF,EAAI,MAAME,EAAEF,EAAI,KACfE,EAAEE,WACX,EAOAqG,UAAW,SAAUrK,GACnB,IAAI8D,EAAItG,EAAGuG,IAAI/D,GAKf,OAJA8D,EAAEF,EAAU,GAANE,EAAEF,EACRE,EAAED,EAAI,IACFC,EAAEF,EAAI,MAAME,EAAEF,EAAI,KAClBE,EAAEF,EAAI,KAAKE,EAAEF,EAAI,IACdE,EAAEE,WACX,EAUAsG,eAAgB,SAAUtK,EAAOuK,EAASpB,EAAOqB,GAC/C,MAAMnB,EAAS7L,EAAGiN,OAAOF,GACzB,IAAIG,EAASlN,EAAGmN,cAActB,OAAOA,GAAQC,MAAM,CAAC,GAAK,IACrDxF,EAAItG,EAAGuG,IAAI/D,GAIf,OAHI8D,EAAEF,EAAI,KAAKE,EAAEF,EAAI,IACrBE,EAAEF,GAA6B,IAAvB,GAAM8G,EAAOvB,IACjBrF,EAAEF,EAAI,KAAKE,EAAEF,EAAI,IACdE,EAAEE,WACX,EAOA4G,eAAgB,SAAUpL,EAAMyJ,GAC9B,GAAwB,IAApBA,EAAU4B,MACZ5B,EAAUjJ,MAAQ,YACb,GAAwB,IAApBiJ,EAAU4B,MACnB5B,EAAUjJ,MAAQR,EAAKsL,YAAY7B,EAAUzD,KAAKuB,UAC7C,GAAwB,IAApBkC,EAAU4B,MACnB5B,EAAUjJ,MAAQ3B,KAAKiM,eACrBrB,EAAUlJ,OAAOC,MACjBiJ,EAAUlJ,OAAOgL,SAAS1K,IAAKY,GAAMA,EAAEkI,OACvCF,EAAUE,MACVF,EAAU4B,MAAQ5B,EAAUzD,KAAKuB,UAE9B,GAAwB,IAApBkC,EAAU4B,QACnB5B,EAAUjJ,MAAQ3B,KAAKiM,eACrBrB,EAAUlJ,OAAOC,MACjBiJ,EAAUlJ,OAAOA,OAAOgL,SAAS1K,IAAKY,GAAMA,EAAEkI,OAC9CF,EAAUE,MACVF,EAAU4B,MAAQ5B,EAAUzD,KAAKuB,KAE/BvH,EAAKwL,OAAOC,WAAW,CACzB,MAAMtC,EAAenJ,EAAKgG,KAAKpE,OAC5BH,GACCA,EAAE2I,eAAiBX,EAAUzD,KAAKuB,KAClC9F,EAAE4I,kBAAoBZ,EAAUlJ,OAAOyF,KAAKuB,KAEhDkC,EAAUjJ,MAAQR,EAAKwL,OAAOC,UAC5BtC,EACAM,EAAUzD,KAAKA,KACfyD,EAAUjJ,MACV,CACEkL,YAAajC,EAAUlJ,OAAOC,MAC9BmL,SAAUlC,EAAUlJ,OAAOA,OAAOgL,SAAS1K,IAAKY,GAAMA,EAAEkI,OACxDA,MAAOF,EAAUE,MACjB0B,MAAO5B,EAAU4B,MACjB7C,OAAQiB,EAAUlJ,OAAOA,QAG/B,CAEEkJ,EAAU8B,UACZ9B,EAAU8B,SAASK,QAASC,GAAUhN,KAAKuM,eAAepL,EAAM6L,GAEpE,EAUArB,UAAW,SAAUL,EAAM2B,GACzB,MAAMC,EAAY5B,EAAOtC,OAAOsC,GAAQ,GAClC6B,GAAe,0BAA0BC,KAAKF,GAC9CG,EAAmBH,EAAUvK,MAAM,MACzC,IAAI2K,EAAW,GAEfD,EAAiBN,QAASQ,IACxB,MAAMC,EAAQD,EAAK5K,MAAM,QACzB,IAAI8K,EAAe,GACfC,EAAQ,EACRC,EAAY,EAChBF,EAAa,GAAK,GAElBD,EAAMT,QAASa,IACTA,EAAK9L,OAAS4L,GAASP,EAAc,EAAI,KAC3CQ,GAAa,EACbD,EAAQ,EACRD,EAAaE,GAAa,IAE5BF,EAAaE,GAAaF,EAAaE,GAAaC,EAAK/K,OAAS,IAClE6K,GAASE,EAAK9L,SAEhB,MAAM+L,EAAgBJ,EAAa1K,OAAQH,GAAMA,EAAEC,QACnDyK,EAAWA,EAASQ,OAAOD,KAG7B,MAAME,EAAa,CACjBxK,EAAG,GACHyK,EAAG,GACHzI,EAAG,GACH0I,EAAG,GACHC,EAAG,GACHC,EAAG,GACHC,EAAG,GACH,EAAG,GACH,IAAK,GACL,IAAK,GACL,IAAK,GACL,IAAK,GACL,IAAK,GACL,IAAK,GACLC,EAAG,IACHC,EAAG,IACHC,EAAG,IACHC,EAAG,IACH,IAAK,IACLC,EAAG,GACHC,EAAG,GACHC,EAAG,GACHC,EAAG,GACHvL,EAAG,GACHmC,EAAG,GACHqJ,EAAG,IACHC,EAAG,EACHC,EAAG,IACHC,EAAG,IACHC,EAAG,IACHC,EAAG,GAUL,MAAMC,EAAa7B,EAAStL,IAAKuL,IAC/B,MAAM6B,EAAc7B,EAAK1K,OAEzB,OADqB,0BAA0BuK,KAAKgC,GATtD,SAA4B9D,GAC1B,OAAO+D,MAAMC,KAAKhE,GAAMiE,OACtB,CAACnP,EAAOoP,IAASpP,GAAS2N,EAAWyB,IAAS,GAC9C,EAEJ,CAMMC,CAAmBL,GACnBA,EAAYtN,SAElB,IAAI4N,EAAY5L,KAAKQ,OAAO6K,GAE5B,GAAIlC,EAAY,MAAO,CAACyC,EAAWpC,EAASxL,QAE5C,MAAM6N,EAAOrC,EACVtL,IACC,CAACY,EAAGW,IAAM,aAAamM,EAAY,cAAiB9M,EAAEC,kBAEvDX,KAAK,IACR,MAAO,mBAAsBoL,EAASxL,OAAS,OAAO6N,WACxD,EAQAC,qBAAsB,SAAUzO,EAAMyB,GACpC,MAAMiN,EAAW7P,KAAK2K,UAAUxJ,EAAKyJ,UAAWhI,IACzCxC,EAAO0P,GAAY9P,KAAK2L,UAAU/I,EAAEuE,KAAKuB,KAAK,GAErD,OAD6B,EAAXmH,GAAgBC,EAAW,EAE/C,EAQAC,YAAa,SAAU5O,EAAMyB,GAC3B,GAAgB,IAAZA,EAAE4J,MAAa,MAAO,CAAC,EAAG,GAC9B,IAAK5J,EAAElB,QAAQF,SAASwO,OAASpN,EAAEpB,SAASwO,KAAM,MAAO,CAAC,EAAG,GAC7D,MAAMC,EAAerN,EAAElB,OAAOF,QAAQwO,KAChCE,EAAgBtN,EAAEpB,QAAQwO,KAChC,GAAIpN,EAAElB,OAAOgL,SAAS5K,OAAS,EAC7B,MAAO,CAACoO,EAAclN,EAAGkN,EAAcjN,GAEzC,MAAMkN,EAAQD,EAAclN,EAAIiN,EAAajN,EACvCoN,EAAQF,EAAcjN,EAAIgN,EAAahN,EAC7C,IAAIoN,EAAO,EACTC,EAAO,EAET,MAAMT,EAAW7P,KAAKoL,WAAWjK,EAAKyJ,UAAWhI,IAC1C2N,EAAWT,GAAY9P,KAAK2L,UAAU/I,EAAEuE,KAAKuB,KAAK,GACnD8H,EAAuB,EAAXX,EAAeC,EAC3BW,EAAsB,EAAXZ,EAAeU,EAC1BG,EAAY5M,KAAKQ,IAAI,GAAIkM,EAAY,GAEvC1M,KAAK6M,IAAIP,GAASM,IACpBL,EAAOD,GAAS,EAAIM,GAAaA,EAC7B5M,KAAK6M,IAAIR,GAASM,IACpBH,EAAOH,GAAS,EAAIM,EAAW,GAAKA,EAAW,IAInD,MAAMG,EAAe5Q,KAAK6Q,iBAAiBjO,EAAElB,OAAOF,SAC9CsP,EAAYZ,EAAclN,EAAIsN,EAC9BjI,EAAY6H,EAAcjN,EAAIoN,EAapC,OAXIS,EAAYF,EAAatJ,KAAOmJ,EAAW,EAC7CH,EAAOM,EAAatJ,KAAOmJ,EAAW,EAAIP,EAAclN,EAC/C8N,EAAYF,EAAarJ,KAAOkJ,EAAW,IACpDH,EAAOM,EAAarJ,KAAOkJ,EAAW,EAAIP,EAAclN,GAEtDqF,EAAYuI,EAAapJ,KAAOgJ,EAAY,EAC9CH,EAAOO,EAAapJ,KAAOgJ,EAAY,EAAIN,EAAcjN,EAChDoF,EAAYuI,EAAanJ,KAAO+I,EAAY,IACrDH,EAAOO,EAAanJ,KAAO+I,EAAY,EAAIN,EAAcjN,GAGpD,CAACiN,EAAclN,EAAIsN,EAAMJ,EAAcjN,EAAIoN,EACpD,EAOAQ,iBAAkB,SAAUrP,GAC1B,MAAM4F,EAAK5F,EAAQQ,IAAK+O,GAAUA,EAAM,IAClC1J,EAAK7F,EAAQQ,IAAK+O,GAAUA,EAAM,IACxC,MAAO,CACLzJ,KAAMxD,KAAKS,OAAO6C,GAClBG,KAAMzD,KAAKQ,OAAO8C,GAClBI,KAAM1D,KAAKS,OAAO8C,GAClBI,KAAM3D,KAAKQ,OAAO+C,GAEtB,EAOA2J,sBAAuB,SAAUpO,GAC/B,IAAKA,EAAEpB,SAASwO,MAAMiB,gBAAgBzP,QAAS,OAAO,EACtD,MAAM0P,EAAOtO,EAAEpB,QAAQwO,KAAKiB,eAAezP,QAAQ0P,OACnD,OAAOpN,KAAKqN,KAAKD,EAAOpN,KAAKW,GAC/B,EASA2M,mBAAoB,SAAUjQ,EAAMyB,EAAGyO,GACrCA,EAAiBA,GAAkB,EACnC,MAAMxB,EAAW7P,KAAK2K,UAAUxJ,EAAKyJ,UAAWhI,GAAKyO,GAC9CC,EAAU3D,GAAa3N,KAAK2L,UAAU/I,EAAEuE,KAAKuB,KAAK,GACzD,OAAO5E,KAAKQ,IAAe,GAAXuL,EAAgByB,EAAW,GAAK,GAClD,EASAC,oBAAqB,SAAUpQ,EAAMyB,EAAGyO,GACtCA,EAAiBA,GAAkB,EACnC,MAAMxB,EAAW7P,KAAK2K,UAAUxJ,EAAKyJ,UAAWhI,GAAKyO,GAC9CC,EAAU3D,GAAa3N,KAAK2L,UAAU/I,EAAEuE,KAAKuB,KAAK,GACzD,OAAO5E,KAAKQ,IAAe,GAAXuL,EAAgBlC,EAAY,IAAK,GACnD,EASA6D,mBAAoB,SAAUrQ,EAAMyB,EAAG4J,GACrC,MAAO,CACL9D,IAAK9F,EAAEuE,KAAKuB,IACZoC,MAAOlI,EAAEkI,MACT0B,MAAO5J,EAAE4J,MACTrF,KAAMvE,EAAEuE,KAAKoD,OAAO,IAAIpD,KACxB0D,MAAOjI,EAAEkI,MAAQ3J,EAAKsQ,WACtBC,YAAavS,EAAGwS,OAAO,MAAVxS,CAAiByD,EAAEkI,MAAQ3J,EAAKsQ,YAC7C9P,MAAOiB,EAAEjB,MACTkL,YAAajK,EAAElB,QAAQC,MACvBiQ,YAAa5R,KAAK4L,YAAYhJ,EAAEjB,MAAO,GAAG,QAC1CkQ,aAAc7R,KAAK4L,YAAYhJ,EAAEjB,MAAO,EAAG,GAAK,IAChDkO,SACY,IAAVrD,EACwC,KAApCxM,KAAK2K,UAAUxJ,EAAKyJ,UAAWhI,GAC/B5C,KAAK2K,UAAUxJ,EAAKyJ,UAAWhI,GACrCkP,QAASlP,EAAEpB,SAASwO,MAAMhN,GAAK,EAC/B+O,QAASnP,EAAEpB,SAASwO,MAAM/M,GAAK,EAC/BzB,QAASoB,EAAEpB,QACXE,OAAQkB,EAAElB,OACN,CACEgH,IAAK9F,EAAElB,OAAOyF,KAAKuB,IACnBoC,MAAOlI,EAAElB,OAAOoJ,MAChBnJ,MAAOiB,EAAElB,OAAOC,OAElB,KACJ+K,SAAU9J,EAAE8J,SACR9J,EAAE8J,SAAS1K,IAAKyD,IAAC,CACfiD,IAAKjD,EAAE0B,KAAKuB,IACZoC,MAAOrF,EAAEqF,MACTnJ,MAAO8D,EAAE9D,SAEX,KACJ8P,WAAYtQ,EAAKsQ,WACjBO,aAAe3O,GAAMrD,KAAKiS,UAAU5O,GACpC6O,cAAgB7O,GAAMlE,EAAGwS,OAAO,MAAVxS,CAAiBkE,GAE3C,EASA4O,UAAW,SAAU5O,GACnB,MAAM,EAAIA,EAAI,IAAM,GAAKS,KAAKqO,MAAM9O,EAAI,IAAM,IAAM,IAAU,EACxD,EAAIA,EAAI,IAAM,EAAIS,KAAK3D,MAAMkD,EAAI,IAAM,GAAK,IAAU,EACtD,EAAI+O,SAAS/O,EAAI,KAAW,IAElC,OACG,GAAK,EAAIlE,EAAGwS,OAAO,OAAVxS,CAAkB,GAAK,KAAO,MACvC,GAAK,EAAIA,EAAGwS,OAAO,OAAVxS,CAAkB,GAAK,KAAO,MACvCkE,EAAI,IAAM,IAAM,GAAK,EAAIlE,EAAGwS,OAAO,OAAVxS,CAAkB,GAAK,KAAO,MACvDkE,EAAI,IAAUlE,EAAGwS,OAAO,OAAVxS,CAAkB2E,KAAK3D,MAAMkD,IAAM,IAEtD,EAUAgP,6BAA8B,SAAUlR,EAAMmR,GAC5CA,EAAQA,IAAS,EACjB,MAGMC,EAAezO,KAAK0O,OAE1B,IAAIC,EAAO,CACT,CAAC,EAAG,GACJ,CAAC,EAAG,GACJ,CAAC,EAAG,GACJ,CAAC,EAAG,IAEFrG,EAAS,CACX,CAAC,EAAG,GACJ,CAAC,EAAG,IAEFzF,EAAO,CAAC,EAAG,GACX+L,EAhB8B,IAiB9BC,EAhBgC,GAiBhCC,EAhB6B,IAiB7BC,EAAON,EACPO,EAAmB,CAAA,EAGnBC,EAA0C5T,EAC3C6T,qBAF0B,CAAC,CAAEC,OAAQ,GAAK,CAAEA,OAAQ,KAGpDC,OAEH,MAAMC,EAAUnT,KAEVoT,EAAkB,SAAUC,GAChCC,EAAQb,EAAMY,EAChB,EAEAD,EAAgBV,iBAAmB,SAAUa,GAC3C,OAAOC,UAAU1R,QACX4Q,EAAmBa,EAAIH,GACzBV,CACN,EACAU,EAAgBT,kBAAoB,SAAUY,GAC5C,OAAOC,UAAU1R,QACX6Q,EAAoBY,EAAIH,GAC1BT,CACN,EACAS,EAAgBR,eAAiB,SAAUW,GACzC,OAAOC,UAAU1R,QACX8Q,EAAiBW,EAAIH,GACvBR,CACN,EACAQ,EAAgBX,KAAO,SAAUc,GAC/B,OAAKC,UAAU1R,QACfiR,EAAwCN,KAAKc,GAC7Cd,EAAOM,EAAwCN,OAC/CrG,EAAS2G,EAAwC3G,SACjDzF,EAAOoM,EAAwCpM,OACxCyM,GALuBX,CAMhC,EACAW,EAAgBhH,OAAS,SAAUmH,GACjC,OAAKC,UAAU1R,QACfiR,EAAwC3G,OAAOmH,GAC/Cd,EAAOM,EAAwCN,OAC/CrG,EAAS2G,EAAwC3G,SACjDzF,EAAOoM,EAAwCpM,OACxCyM,GALuBhH,CAMhC,EACAgH,EAAgBzM,KAAO,SAAU4M,GAC/B,OAAKC,UAAU1R,QACfiR,EAAwCpM,KAAK4M,GAC7Cd,EAAOM,EAAwCN,OAC/CrG,EAAS2G,EAAwC3G,SACjDzF,EAAOoM,EAAwCpM,OACxCyM,GALuBzM,CAMhC,EACAyM,EAAgBP,KAAO,SAAUU,GAC/B,OAAOC,UAAU1R,QAAW+Q,EAAOU,EAAIH,GAAmBP,CAC5D,EACAO,EAAgBN,iBAAmB,SAAUS,GAC3C,OAAOC,UAAU1R,QACXgR,EAAmBS,EAAIH,GACzBN,CACN,EAEA,MAAMQ,EAAU,SAAUG,EAAiB/S,GACzC,IAAIgT,EAGJ,GAFAhT,EAAKc,QAAUiS,EAEI,GAAf/S,EAAK2F,OAAa,CAepB,IADA,IAAIsN,GAbJD,EAAavU,EACV6T,qBAAqBtS,EAAKgM,UAC1B+F,KAAKgB,GACLR,OAAQrQ,GAAMA,EAAEkI,OAChB4H,iBAAiBA,GACjBC,kBAAkBA,GAClBC,eAAeA,GACfC,KAAKA,GACLe,gBACCT,EAAQU,wBAAwB1S,EAAM2R,EAAkBR,IAEzDY,QAEoBS,SACfA,EAAMG,OACZJ,EAAWK,OACXJ,EAAQD,EAAWC,QAGrBA,EAAMK,SAASjH,QAAQ,SAAUkH,GAC3BA,EAAGjE,MAAMiB,gBAAgB9J,MAAMmD,cACjCgJ,EAAQW,EAAIA,EAAGjE,KAAKiB,eAAe9J,KAAKmD,aAE5C,EACF,CACF,EAEA,OAAO8I,CACT,EASAS,wBAAyB,SAAU1S,EAAM2R,EAAkBR,GAEzD,IAAImB,EAAiBrH,EAAQ9E,EAAMC,EAAMC,EAAMC,EAAMyM,EAAIC,EAWzD,SAASC,EAAwB1T,EAAMoS,GACrC,OAAOA,EAAiBuB,KACrBC,GAAQA,EAAI9H,QAAU9L,EAAK8L,OAAS8H,EAAI5L,MAAQhI,EAAKyG,KAAKuB,IAE/D,CAkJA,OA/DgB,SAAU9F,EAAGW,EAAGgR,EAAKvB,GACnC,IAAIwB,GAAwB,EAU5B,GATIf,IAAoBT,EAAqBP,SAC3CgB,EAAkBT,EAAqBP,OACvCrG,EAAS4G,EAAqB5G,SAC9BoI,GAAwB,GAEtBA,IAtGJlN,EAAO8E,EAAO,GAAG,GACjB7E,EAAO6E,EAAO,GAAG,GACjB5E,EAAO4E,EAAO,GAAG,GACjB3E,EAAO2E,EAAO,GAAG,GACjB8H,EAAK3M,EAAOD,EACZ6M,EAAK1M,EAAOD,GAqGI,IAAZ5E,EAAE4J,MACJ,MAAO,EAAElF,EAAOC,GAAQ,GAAIC,EAAOC,GAAQ,GAG7C,MAAM/F,EAASkB,EAAElB,QAAU6S,EAAI,GAAG7S,OAE5B+S,EAlGR,SAAoC3H,EAAUgG,GAC5C,OAAOhG,EACJ9K,IAAK0S,GAAYN,EAAwBM,EAAS5B,IAClD/P,OAAQuR,QAAgBK,IAARL,EACrB,CA8FkCM,CADflT,EAASA,EAAOgL,SAAW6H,EAG1CzB,GAGF,GAAI2B,EAAwB3S,OAAS,EAAG,CACtC,MAAM+S,EAAiB1V,EAAGiN,OAAOqI,EAA0B7R,GAAMA,EAAEI,GAC7D8R,EAAiB3V,EAAGiN,OAAOqI,EAA0B7R,GAAMA,EAAEK,GAC7D8R,EAAsBX,EAC1BxR,EACAkQ,GAGF,GAAIiC,EAAqB,CACvB,MAAM/R,EAAI+R,EAAoB/R,EAAI7B,EAAKf,MACjC6C,EAAI8R,EAAoB9R,EAAI9B,EAAKkF,OAEvC,GAAIlH,EAAG6V,gBAAgBvB,EAAiB,CAACzQ,EAAGC,IAC1C,MAAO,CAACD,EAAGC,GAGb,MAAOgS,EAASC,GA1FtB,SAA2BlS,EAAGC,EAAGkS,EAAe1B,GAC9C,MAAMrP,EAAQN,KAAKsR,MAAMnS,EAAGD,GACtBqS,EAAkBjR,EAAQ,EAAIA,EAAQ,EAAIN,KAAKW,GAAKL,EAE1D,IAAIkR,EAAYC,EAAUC,EAAYC,EACtC,IAAK,IAAIlS,EAAI,EAAGA,EAAI4R,EAAcrT,OAAQyB,IACxC,GAAI8R,GAAmBF,EAAc5R,GAAGa,MAAO,CAC7CkR,EACQ,IAAN/R,EACI4R,EAAcA,EAAcrT,OAAS,GAAGsC,MACxC+Q,EAAc5R,EAAI,GAAGa,MAC3BmR,EAAWJ,EAAc5R,GAAGa,MAC5BoR,EACQ,IAANjS,EACI4R,EAAcA,EAAcrT,OAAS,GACrCqT,EAAc5R,EAAI,GACxBkS,EAAWN,EAAc5R,GACzB,KACF,MAGiBoR,IAAfW,IACFA,EAAaH,EAAcA,EAAcrT,OAAS,GAAGsC,MACrDmR,EAAWJ,EAAc,GAAG/Q,MAAQ,EAAIN,KAAKW,GAC7C+Q,EAAaL,EAAcA,EAAcrT,OAAS,GAClD2T,EAAWN,EAAc,IAG3B,MAAMlH,GAAKoH,EAAkBC,IAAeC,EAAWD,GACjDI,EAAQF,EAAWxS,EAAIiL,GAAKwH,EAASzS,EAAIwS,EAAWxS,GACpD2S,EAAQH,EAAWvS,EAAIgL,GAAKwH,EAASxS,EAAIuS,EAAWvS,GAIpD4H,EAFkB/G,KAAKqN,KAAKnO,EAAIA,EAAIC,EAAIA,GAC1Ba,KAAKqN,KAAK,GACkB,GAE1C8D,EAAUpK,EAAQ6K,EAClBR,EAAUrK,EAAQ8K,EAElBC,EAAiBzW,EAAGiN,OAAOqH,EAAkB7Q,GAAMA,EAAE,IACrDiT,EAAiB1W,EAAGiN,OAAOqH,EAAkB7Q,GAAMA,EAAE,IAS3D,MAAO,CAPQzD,EAAGmN,cAActB,OAAO,EAAC,EAAI,IAAIC,MAAM2K,EAAvCzW,CACb8V,GAEa9V,EAAGmN,cAActB,OAAO,EAAC,EAAI,IAAIC,MAAM4K,EAAvC1W,CACb+V,GAGsBG,EAAiBxK,EAAO,CAAC7H,EAAGC,GACtD,CAwCiC6S,CACzB3W,EAAGmN,cAActB,OAAO6J,GAAgB5J,MAAM,IAAK,GAAnD9L,CACE4V,EAAoB/R,GAEtB7D,EAAGmN,cAActB,OAAO8J,GAAgB7J,MAAM,IAAK,GAAnD9L,CACE4V,EAAoB9R,GAtH9B,SAA0BwQ,GACxB,MAAMmC,EAAiBzW,EAAGiN,OAAOqH,EAAkB7Q,GAAMA,EAAE,IACrDiT,EAAiB1W,EAAGiN,OAAOqH,EAAkB7Q,GAAMA,EAAE,IAE3D,OAAO6Q,EACJzR,IAAK+O,IACJ,MAAM/N,EAAI7D,EAAGmN,cAActB,OAAO4K,GAAgB3K,MAAM,IAAK,GAAnD9L,CACR4R,EAAM,IAEF9N,EAAI9D,EAAGmN,cAActB,OAAO6K,GAAgB5K,MAAM,IAAK,GAAnD9L,CACR4R,EAAM,IAEF3M,EAAQN,KAAKsR,MAAMnS,EAAGD,GAC5B,MAAO,CACLoB,MAAOA,EAAQ,EAAIA,EAAQ,EAAIN,KAAKW,GAAKL,EACzC2M,MAAOA,EACP/N,EAAGA,EACHC,EAAGA,KAGN8S,KAAK,CAACtH,EAAGuH,IAAMvH,EAAErK,MAAQ4R,EAAE5R,MAChC,CAmGQ6R,CAAiBxC,GACjBA,GAGF,MAAO,CAACwB,EAASC,EACnB,CACF,CAGA,IAAIlS,EAAGC,EACP,GACED,EAAIsE,EAAO4M,EAAKlB,EAAqBH,MAArBG,GAChB/P,EAAIuE,EAAO2M,EAAKnB,EAAqBH,MAArBG,UACR7T,EAAG6V,gBAAgBvB,EAAiB,CAACzQ,EAAGC,KAElD,MAAO,CAACD,EAAGC,EACb,CAGF,GC7rBK,SAASiT,EAAeC,GAE7B,MAAMC,EAAgBC,SAASC,cAAc,0BAG7C,GAFIF,GAAeA,EAAcxV,UAE5BuV,EACH,OAAO,KAGT,MAAMI,EAAQJ,EAAYI,MACpBpP,EAAOgP,EAAYhP,MAAQ,CAAA,EAG3BqP,EAAQH,SAASI,cAAc,OACrCD,EAAME,UAAY,wBAGlB,MAAM1T,EAAIuT,EAAMI,MACV1T,EAAIsT,EAAMK,MAChBJ,EAAM3U,MAAMgV,KAAO7T,EAAI,KACvBwT,EAAM3U,MAAMiV,IAAM7T,EAAI,KAGtB,MAAM8T,EAAUV,SAASI,cAAc,OA4BvC,OA3BAM,EAAQL,UAAY,wBACpBK,EAAQC,UAAY,yFAEd7P,EAAKqE,iBAAmB,8FAGCrE,EAAKwC,QAAU,8DAGjBxC,EAAKyC,YAAc,wBAIhD4M,EAAMS,YAAYF,GAClBV,SAASa,KAAKD,YAAYT,GAG1BlO,WAAW,KACT,MAAM6O,EAAgBzI,IACf8H,EAAMY,SAAS1I,EAAE2I,UACpBb,EAAM5V,SACNyV,SAASiB,oBAAoB,QAASH,KAG1Cd,SAASkB,iBAAiB,QAASJ,IAClC,GAEIX,CACT,CAmFO,SAASgB,IACd,MAAO,wgGAgKT,CChVA,MAAMC,EACJ,WAAA3X,GACEE,KAAKoG,OAAS,CAAE0Q,IAAK,GAAIY,MAAO,GAAIC,OAAQ,GAAId,KAAM,IACtD7W,KAAKuI,IAAM,KACXvI,KAAKmH,KAAO,KACZnH,KAAK4K,UAAY,KACjB5K,KAAK4X,SAAW,KAChB5X,KAAK6X,gBAAkB,KACvB7X,KAAK8X,eAAiB,IACxB,CAGA,yBAAWC,GACT,MAAO,01BAA01BpV,MAC/1B,IAEJ,CAGA,0BAAWqV,GACT,MAAO,CACL5X,MAAO,IACPiG,OAAQ,IACR4R,SAAU,GACVC,QAAS,GACTC,UAAW,OACXvL,UAAW,KACXwL,cAAe,KACfC,UAAW,IACXC,WAAY,EACZC,QAAS,EACTC,OAAQf,EAAeM,eACvBU,WAAY,GACZC,YAAY,EACZC,aAAa,EACbC,YAAY,EACZC,gBAAiB,KACjBC,cAAe,KACfxG,OAAO,EACPyG,YAAa,GACbC,YAAa,EACbC,aAAc,GAEdC,oBAAqB,KACrBC,wBAAyB,KAE7B,CAGA,kBAAIC,GAIF,OAHKpZ,KAAK6X,kBACR7X,KAAK6X,gBAAkB,IAAIhY,EAAeV,IAErCa,KAAK6X,eACd,CAEA,iBAAIwB,GAIF,OAHKrZ,KAAK8X,iBACR9X,KAAK8X,eAAiB,IAAIlS,EAAczG,IAEnCa,KAAK8X,cACd,CAUA,MAAA7X,CAAOkH,EAAMrB,EAAU,IAerB,OAdA9F,KAAK2M,OAAS,IAAK8K,EAAeO,mBAAoBlS,GACtD9F,KAAKmH,KAAOA,EAEZnH,KAAKsZ,YACLtZ,KAAKuZ,eACLvZ,KAAKwZ,eACLxZ,KAAKyZ,uBACLzZ,KAAK0Z,0BACL1Z,KAAK2Z,iBACL3Z,KAAK4Z,aACL5Z,KAAK6Z,cACL7Z,KAAK8Z,mBACL9Z,KAAK+Z,oBAEE/Z,KAAKuI,IAAI7H,MAClB,CAOA,MAAAsZ,CAAOC,GACL,OAAOja,KAAKC,OAAOga,EAASja,KAAK2M,OACnC,CAIA,SAAA2M,GAEEtZ,KAAKuI,IAAMpJ,EACR+a,OAAO,OACPnZ,KAAK,QAASf,KAAK2M,OAAOvM,MAAQJ,KAAKoG,OAAOyQ,KAAO7W,KAAKoG,OAAOsR,OACjE3W,KACC,SACAf,KAAK2M,OAAOtG,OAASrG,KAAKoG,OAAO0Q,IAAM9W,KAAKoG,OAAOuR,QAIvD3X,KAAKuI,IAAIlG,OAAO,SAASiJ,KDiEpB,0gGC/DLtL,KAAKuI,IACFlG,OAAO,QACPtB,KAAK,QAAS,QACdA,KAAK,SAAU,QACfc,MAAM,OAAQ,QAEjB7B,KAAKI,MAAQJ,KAAK2M,OAAOvM,MAAQ0D,KAAKqN,KAAKnR,KAAK2M,OAAO4L,SACvDvY,KAAKqG,OAASrG,KAAKI,OAASJ,KAAK2M,OAAOtG,OAASrG,KAAK2M,OAAOvM,MAC/D,CAEA,YAAAmZ,GAEE,MAAM1P,EAASN,EACbvJ,KAAKmH,KACL,kBACA,gBAGFnH,KAAK4K,UAAYzL,EAAGyL,UAAUf,EAASjH,GAAMA,EAAE2H,QAAQR,IAAKnH,GAAMA,EAAE+D,MAEpE3G,KAAKyR,WAAazR,KAAK4K,UAAUE,KACnC,CAEA,YAAA0O,GACExZ,KAAKS,WAAaT,KAAKuI,IACpBlG,OAAO,KACPtB,KAAK,YAAa,aAAaf,KAAKoG,OAAOyQ,QAAQ7W,KAAKoG,OAAO0Q,QAElE9W,KAAKma,aAAena,KAAKS,WAAW4B,OAAO,KAAKtB,KAAK,QAAS,QAC9Df,KAAKoa,YAAcpa,KAAKS,WAAW4B,OAAO,KAAKtB,KAAK,QAAS,UAC7Df,KAAKqa,eAAiBra,KAAKS,WAAW4B,OAAO,KAAKtB,KAAK,QAAS,OAChEf,KAAKsa,eAAiBta,KAAKS,WAAW4B,OAAO,KAAKtB,KAAK,QAAS,UAChEf,KAAKua,mBAAqBva,KAAKS,WAC5B4B,OAAO,KACPtB,KAAK,QAAS,WACjBf,KAAKwa,kBAAoBxa,KAAKS,WAC3B4B,OAAO,KACPtB,KAAK,QAAS,SACnB,CAEA,oBAAA0Y,GACEzZ,KAAKuI,IACFlG,OAAO,KACPA,OAAO,QACPtB,KAAK,QAAS,SACdA,KAAK,cAAe,UACpBA,KAAK,YAAa,MAClBA,KAAK,cAAe,OACpBA,KACC,YACA,aAAaf,KAAKoG,OAAOyQ,KAAO7W,KAAKI,MAAQ,KAC3CJ,KAAKoG,OAAO0Q,IAAM,OAGrBnH,KAAK3P,KAAK2M,OAAOsL,UAEpBjY,KAAKuI,IACFlG,OAAO,KACPA,OAAO,QACPtB,KAAK,QAAS,WACdA,KAAK,cAAe,UACpBA,KAAK,YAAa,MAClBA,KAAK,cAAe,OACpBA,KAAK,OAAQ,QACbA,KACC,YACA,aAAaf,KAAKoG,OAAOyQ,KAAO7W,KAAKI,MAAQ,KAC3CJ,KAAKoG,OAAO0Q,IAAM9W,KAAKqG,OAAS,OAGnCsJ,KAAK3P,KAAK2M,OAAOuL,QACtB,CAEA,uBAAAwB,GAEE,MAAMe,EAActb,EAAGub,OACrB1a,KAAKmH,KACJ6C,GAAM7K,EAAG4K,IAAIC,EAAIpH,GAAMkE,WAAWlE,EAAEgH,aAAe,GACnDhH,GAAMA,EAAE+G,QAILgR,EAAgBtL,MAAMC,KAAKmL,EAAYG,WAC1C7E,KAAK,CAACtH,EAAGuH,IAAMA,EAAE,GAAKvH,EAAE,IACxBzM,IAAKY,GAAMA,EAAE,KAEVqW,aAAEA,EAAcT,OAAQqC,GAAkB7a,KAAK2M,OAC/CmO,EAAiB,IAAIC,IAAI9B,EAAajX,IAAKY,GAAM,CAACA,EAAE8F,IAAK9F,EAAEjB,SAEjE,IAAIqZ,EAAe,CAAA,EAGnBL,EAAc5N,QAAQ,CAACrE,EAAKnF,KAC1ByX,EAAatS,GAAOmS,EAActX,EAAIsX,EAAc/Y,UAItDgZ,EAAe/N,QAAQ,CAACpL,EAAO+G,KAC7BsS,EAAatS,GAAO/G,IAGtB3B,KAAKyM,YAActN,EAChB8b,eACAjQ,OAAO5L,OAAO8b,KAAKF,IACnB/P,MAAM7L,OAAOmL,OAAOyQ,GACzB,CAIA,cAAArB,GACE,MAAMwB,EAAUhc,EAAG8L,MAAM,KAAKjJ,IAAKuB,IACjC,IAAIP,EAAIc,KAAKsX,IAAK7X,EAAI,GAAMO,KAAKW,IACjC,MAAMH,EAAM,IACRtB,EAAIsB,IAAKtB,EAAIsB,EAAkB,IAAXtB,EAAIsB,IACxBtB,GAAKsB,IAAKtB,EAAuB,IAAXA,EAAIsB,GAAXA,GACnBtB,GAAQ,IACR,MAAMC,EAAIa,KAAKuX,IAAK9X,EAAI,GAAMO,KAAKW,IACnC,MAAO,CACJzE,KAAKI,OAAS,EAAI,IAAO4C,GAAM,EAC/BhD,KAAKqG,QAAU,EAAI,IAAOpD,GAAM,KAI/BqY,EAAOnc,EAAGO,WAAWM,KAAK2M,OAAO8L,YAKvC,GAHqBtZ,EAAGoc,iBAAiB1I,KAAKyI,GAAM7I,KAAK0I,EACzDK,CAAexb,KAAK4K,WAEhB5K,KAAK2M,OAAOkM,iBAAmD,SAAhC7Y,KAAK2M,OAAOkM,gBAA4B,CACzE,MAAM4C,EAAkBzb,KAAK0b,oBAC3B1b,KAAK2M,OAAOkM,iBAIZnO,EAAsB2H,6BACpBrS,KACAA,KAAK2M,OAAO2F,OAEX3L,KAAK,CAAC3G,KAAKI,MAAOJ,KAAKqG,SACvBoM,KAAK0I,GACLtI,KAAKyI,GACLxI,iBAAiB2I,EAEtBE,CAAuB3b,KAAK4K,UAC9B,CAUA,GARAF,EAAsB6B,eAAevM,KAAMA,KAAK4K,WAEhD5K,KAAK4X,SAAW5X,KAAK4K,UAClBgR,cACA7F,KAAK,CAACtH,EAAGuH,IAAMA,EAAExJ,MAAQiC,EAAEjC,OAC3BxK,IAAI,CAACY,EAAGW,IAAMnE,OAAOC,OAAO,CAAA,EAAIuD,EAAG,CAAEiZ,GAAItY,KAGxCvD,KAAK2M,OAAOyL,cAAe,CAC7B,MAAM0D,EAAa9b,KAAK+b,qBACxB/b,KAAK2M,OAAOyL,cAAc0D,EAC5B,CACF,CAOA,kBAAAC,GACE,MAAMD,EAAa,GAYnB,OAVA9b,KAAK4K,UAAUgR,cAAc7O,QAAQrM,IAC/BA,EAAK8L,MAAQ,GACfsP,EAAW5W,KAAK,CACdsH,MAAO9L,EAAK8L,MACZ9D,IAAKhI,EAAKyG,KAAKuB,IACf/G,MAAOjB,EAAKiB,UAKXma,CACT,CAEA,mBAAAJ,CAAoB7C,GAClB,MAAMmD,EAAS,GACTC,EAAiBjc,KAAK4K,UAAUgR,cAGhCM,EAAyB,CAACC,EAAWC,EAAe,OACxD,MAAMC,EAAc,IAAItB,IAiBxB,OAfAoB,EAAUpP,QAASuH,IACjB,MAAM5L,EAAM,GAAG4L,EAAItR,EAAEsZ,QAAQ,MAAMhI,EAAIrR,EAAEqZ,QAAQ,KAC3C5O,EAAQ2O,EAAYE,IAAI7T,IAAQ,EAEtC,GAAIgF,EAAQ,EAAG,CAEb,MAAMtJ,EAAiB,IAARsJ,GAAgB,EAAI5J,KAAKW,IAClC+X,EAASJ,EAAetY,KAAKqN,KAAKzD,GACxC4G,EAAItR,EAAIc,KAAKQ,IAAI,IAAMR,KAAKS,IAAI,IAAM+P,EAAItR,EAAIwZ,EAAS1Y,KAAKsX,IAAIhX,KAChEkQ,EAAIrR,EAAIa,KAAKQ,IAAI,IAAMR,KAAKS,IAAI,IAAM+P,EAAIrR,EAAIuZ,EAAS1Y,KAAKuX,IAAIjX,IAClE,CAEAiY,EAAYI,IAAI/T,EAAKgF,EAAQ,KAGxByO,GAIHO,EAAS7D,EAAgB9V,OAAQd,GAAkB,IAAZA,EAAEuK,OAC/C,GAAIkQ,EAAO5a,OAAS,EAAG,CACrB,MAAM6a,EAAUxd,EAAGiN,OAAOsQ,EAASza,GAAMA,EAAEe,GACrC4Z,EAAUzd,EAAGiN,OAAOsQ,EAASza,GAAMA,EAAEgB,GAErC4Z,EACJF,EAAQ,KAAOA,EAAQ,GACnB,IAAM,GACNxd,EAAGmN,cAActB,OAAO2R,GAAS1R,MAAM,CAAC,IAAM,MAC9C6R,EACJF,EAAQ,KAAOA,EAAQ,GACnB,IAAM,GACNzd,EAAGmN,cAActB,OAAO4R,GAAS3R,MAAM,CAAC,IAAM,MAE9C8R,EAAmBL,EAAO1a,IAAKsS,IAAG,IACnCA,EACHtR,EAAG6Z,EAAOvI,EAAItR,GACdC,EAAG6Z,EAAOxI,EAAIrR,MAIhBiZ,EAAuBa,GACvBf,EAAO9W,QAAQ6X,EACjB,CA4CA,MAzCA,CAAC,EAAG,GAAGhQ,QAASP,IACd,MAAMwQ,EAAiBnE,EAAgB9V,OAAQd,GAAMA,EAAEuK,QAAUA,GACjE,GAA8B,IAA1BwQ,EAAelb,OAAc,OAGjC,MAAMmb,EAAehB,EAAelZ,OAAQM,GAAMA,EAAEmJ,QAAUA,GAC7CrN,EAAG+d,MAAMD,EAAe5Z,GAAMA,EAAE3B,QAAQyF,MAAMuB,KAEtDqE,QAAQ,CAACD,EAAUqQ,KAE1B,MAAMC,EAAc,IAAIC,IAAIvQ,EAAS9K,IAAKwD,GAAMA,EAAE2B,KAAKuB,MACjD4U,EAAmBN,EAAeja,OAAQd,GAC9Cmb,EAAYG,IAAItb,EAAEyG,MAGpB,GAAgC,IAA5B4U,EAAiBxb,OAAc,OAEnC,MAAM6a,EAAUxd,EAAGiN,OAAOkR,EAAmBrb,GAAMA,EAAEe,GAC/C4Z,EAAUzd,EAAGiN,OAAOkR,EAAmBrb,GAAMA,EAAEgB,GAE/C4Z,EACJF,EAAQ,KAAOA,EAAQ,GACnB,IAAM,GACNxd,EAAGmN,cAActB,OAAO2R,GAAS1R,MAAM,CAAC,IAAM,MAC9C6R,EACJF,EAAQ,KAAOA,EAAQ,GACnB,IAAM,GACNzd,EAAGmN,cAActB,OAAO4R,GAAS3R,MAAM,CAAC,IAAM,MAE9CuS,EAAoBF,EAAiBtb,IAAKsS,IAAG,IAC9CA,EACHtR,EAAG6Z,EAAOvI,EAAItR,GACdC,EAAG6Z,EAAOxI,EAAIrR,MAIhBiZ,EAAuBsB,GACvBxB,EAAO9W,QAAQsY,OAIZxB,CACT,CAIA,UAAApC,GACE,MAAMzB,UAAEA,GAAcnY,KAAK2M,OACrBxL,EAAOnB,KAEbA,KAAKma,aACF/Y,UAAU,QACV+F,KAAKnH,KAAK4X,UACV6F,QACApb,OAAO,QACPtB,KAAK,IAAM6B,GAAM,IAAMA,EAAEpB,QAAQU,KAAK,KAAO,KAC7CL,MAAM,OAASe,GAAMA,EAAEjB,OAASiB,EAAElB,OAAOC,OACzCZ,KAAK,QAAU6B,GAAM,aAAaA,EAAE4J,cAAc5J,EAAEiZ,MACpDha,MAAM,eAAiBe,GAAmB,IAAZA,EAAE4J,MAAc,EAAI,GAClDzL,KAAK,iBAAmB6B,GAAmB,IAAZA,EAAE4J,MAAc,MAAQ,QACvDkR,GAAG,QAAS,SAAUhP,EAAG9L,GACxB,IAAIsO,EAAO/P,EAAKgZ,aAAa5Z,OAAO,SAASqC,EAAEiZ,MAC/C,MAAM8B,EAAUzM,EAAKnQ,KAAK,SAAS8F,MAAM,WACzC1F,EAAKgZ,aAAa5Z,OAAO,YAAYqd,QAAQ,WAAW,GACxD1M,EAAK0M,QAAQ,WAAYD,GACzBxF,EAAUwF,EAAU,GAAK,IAAK/a,EAAEuE,KAAMoP,MAAO7H,EAAG9L,IAAGib,UAAW3M,GAChE,GACCwM,GAAG,aAAc,SAAUhP,EAAG9L,GAE7B,MAAMkb,EAAS3c,EAAK4c,uBAAuBxB,IAAI3Z,EAAEuE,KAAKA,KAAKqE,iBACvDsS,IAAQA,EAAOpd,OAAOmB,MAAMmc,QAAU,GAE1C,MAAMC,EAAQ9c,EAAK+c,oBAAoB3B,IAAI3Z,EAAEuE,KAAKA,KAAKoE,cACnD0S,IAAOA,EAAMvd,OAAOmB,MAAMmc,QAAU,EAE1C,GACCN,GAAG,aAAc,SAAUhP,EAAG9L,GAE7B,MAAM0V,EAAanX,EAAKwL,OAAO2L,WAEzBwF,EAAS3c,EAAK4c,uBAAuBxB,IAAI3Z,EAAEuE,KAAKA,KAAKqE,iBACvDsS,IACFA,EAAOpd,OAAOmB,MAAMmc,QAAUF,EAAOK,cAAgB7F,EAAa,EAAI,GAGxE,MAAM2F,EAAQ9c,EAAK+c,oBAAoB3B,IAAI3Z,EAAEuE,KAAKA,KAAKoE,cACnD0S,IACFA,EAAMvd,OAAOmB,MAAMmc,QAAUC,EAAME,cAAgB7F,EAAa,EAAI,EAGxE,EACJ,CAEA,WAAAuB,GACE7Z,KAAKoe,oBACLpe,KAAKqe,wBACLre,KAAKse,qBACLte,KAAKue,oBACLve,KAAKwe,gBACP,CAEA,gBAAA1E,GAEE9Z,KAAK+d,sBAAwB,IAAIhD,IACjC/a,KAAKke,mBAAqB,IAAInD,IAG9B/a,KAAKsa,eAAelZ,UAAU,qBAAqBuH,QAAQoE,QAASrM,IAClE,MAAMgI,EAAMhI,EAAK+d,aAAa,mBAC9B,GAAI/V,EAAK,CACP,MAAMgW,EAAYvf,EAAGoB,OAAOG,GAC5Bge,EAAUP,aAAerX,WAAWpG,EAAK+d,aAAa,gBAAkB,EACxEze,KAAK+d,sBAAsBtB,IAAI/T,EAAKgW,EACtC,IAIF1e,KAAKoa,YAAYhZ,UAAU,kBAAkBuH,QAAQoE,QAASrM,IAC5D,MAAMgI,EAAMhI,EAAK+d,aAAa,gBAC9B,GAAI/V,EAAK,CACP,MAAMgW,EAAYvf,EAAGoB,OAAOG,GAC5Bge,EAAUP,aAAerX,WAAWpG,EAAK+d,aAAa,gBAAkB,EACxEze,KAAKke,mBAAmBzB,IAAI/T,EAAKgW,EACnC,GAEJ,CAEA,iBAAAN,GACE,MAAM1F,WAAEA,EAAUQ,oBAAEA,GAAwBlZ,KAAK2M,OAG3CgS,EAAc3e,KAAK4X,SAAS7U,OAAQH,GAAkB,IAAZA,EAAE4J,OAG9C0M,EACFlZ,KAAKwa,kBACFpZ,UAAU,iBACV+F,KAAKwX,GACLlB,QACApb,OAAO,iBACPtB,KAAK,QAAS,wBACdA,KAAK,cAAgB6B,GAAMA,EAAEuE,KAAKuB,KAClC3H,KAAK,QAAU6B,IACd,MAAMgc,EAASlU,EAAsBmG,iBAAiBjO,EAAEpB,SAExD,MAAe,IADDod,EAAOrX,KAAOqX,EAAOtX,QAGpCvG,KAAK,SAAW6B,GACf8H,EAAsB6G,oBAAoBvR,KAAM4C,EAAG,MAEpD7B,KAAK,IAAM6B,IACV,IAAKA,EAAEpB,SAASwO,KAAM,OAAO,EAC7B,MAAM4O,EAASlU,EAAsBmG,iBAAiBjO,EAAEpB,SAClDpB,EAAQwe,EAAOrX,KAAOqX,EAAOtX,KACnC,OAAO1E,EAAEpB,QAAQwO,KAAKhN,EAAa,GAAR5C,EAAe,IAE3CW,KACC,IACC6B,GACMA,EAAEpB,SAASwO,KACTpN,EAAEpB,QAAQwO,KAAK/M,EACsC,GAA1DyH,EAAsB6G,oBAAoBvR,KAAM4C,EAAG,KACnD8H,EAAsBkF,qBAAqB5P,KAAM4C,GAHtB,GAMhCf,MAAM,UAAW6W,EAAa,EAAI,GAClC7W,MAAM,iBAAkB,QACxBA,MAAM,WAAY,WAClBQ,OAAO,aACPR,MAAM,QAAS,QACfA,MAAM,SAAU,QAChBA,MAAM,UAAW,QACjBA,MAAM,cAAe,UACrBA,MAAM,kBAAmB,UACzB8N,KAAM/M,IACL,MAAMic,EAAcnU,EAAsBiB,UAAU/I,EAAEuE,KAAKuB,KACrDoW,EAAUpU,EAAsB8G,mBAAmBxR,KAAM4C,EAAG,GAClE,OAAOsW,EAAoBtW,EAAGic,EAAaC,KAI/C9e,KAAKwa,kBACFpZ,UAAU,QACV+F,KAAKwX,GACLlB,QACApb,OAAO,QACPtB,KAAK,QAAS,UACdA,KAAK,cAAe,SACpBA,KAAK,QAAU6B,GAAMA,EAAEkI,MAAQlI,EAAElB,OAAOoJ,OACxCjJ,MACC,YACCe,GACsD,KAArD8H,EAAsBC,UAAU3K,KAAK4K,UAAWhI,GAAY,MAE/Df,MAAM,eAAgB6W,EAAa,EAAI,GACvC7W,MAAM,iBAAkB6W,EAAa,IAAO,GAC5C7W,MACC,SACCe,GAAM,GAAG8H,EAAsBkB,YAAYhJ,EAAEjB,MAAO,QAAU,OAEhEZ,KAAK,cAAe,UACpBA,KACC,YACC6B,GACMA,EAAEpB,SAASwO,KACT,aAAa,CAClBpN,EAAEpB,QAAQwO,KAAKhN,EACfJ,EAAEpB,QAAQwO,KAAK/M,EACbyH,EAAsBkF,qBAAqB5P,KAAM4C,OAJxB,kBAQhC+M,KAAM/M,GAAM8H,EAAsBiB,UAAU/I,EAAEuE,KAAKuB,KAE1D,CAEA,qBAAA2V,GACE,MAAM/F,WAAEA,EAAUa,wBAAEA,GAA4BnZ,KAAK2M,OAG/CoS,EAAkB/e,KAAK4X,SAAS7U,OAAQH,GAAkB,IAAZA,EAAE4J,OAGlD2M,EACFnZ,KAAKsa,eACFlZ,UAAU,iBACV+F,KAAK4X,GACLtB,QACApb,OAAO,iBACPtB,KAAK,QAAS,4BACdA,KAAK,kBAAoB6B,GAAMA,EAAEuE,KAAKuB,KACtC3H,KAAK,aAAe6B,GAAMA,EAAEkI,OAC5B/J,KAAK,aAAe6B,GAAMA,EAAEkI,MAAQ9K,KAAKyR,YAEzC1Q,KAAK,QAAU6B,IACd,MAAMgc,EAASlU,EAAsBmG,iBAAiBjO,EAAEpB,SAExD,MAAe,IADDod,EAAOrX,KAAOqX,EAAOtX,QAGpCvG,KAAK,SAAW6B,GACf8H,EAAsB6G,oBAAoBvR,KAAM4C,EAAG,MAEpD7B,KAAK,IAAM6B,IACV,IAAKA,EAAEpB,SAASwO,KAAM,OAAO,EAC7B,MAAM4O,EAASlU,EAAsBmG,iBAAiBjO,EAAEpB,SAClDpB,EAAQwe,EAAOrX,KAAOqX,EAAOtX,KACnC,OAAO1E,EAAEpB,QAAQwO,KAAKhN,EAAa,GAAR5C,EAAe,IAE3CW,KACC,IACC6B,GACMA,EAAEpB,SAASwO,KACTpN,EAAEpB,QAAQwO,KAAK/M,EACsC,IAA1DyH,EAAsB6G,oBAAoBvR,KAAM4C,EAAG,KACnD8H,EAAsBkF,qBAAqB5P,KAAM4C,GAHtB,GAMhC7B,KAAK,UAAY6B,GAChBA,EAAEkI,MAAQ9K,KAAKyR,YAAc6G,EAAa,EAAI,GAE/CzW,MAAM,iBAAkB,QACxBA,MAAM,WAAY,WAClBQ,OAAO,aACPR,MAAM,QAAS,QACfA,MAAM,SAAU,QAChBA,MAAM,UAAW,QACjBA,MAAM,cAAe,UACrBA,MAAM,kBAAmB,UACzB8N,KAAM/M,IACL,MAAMic,EAAcnU,EAAsBiB,UAAU/I,EAAEuE,KAAKuB,KACrDoW,EAAUpU,EAAsB8G,mBAAmBxR,KAAM4C,EAAG,GAClE,OAAOuW,EAAwBvW,EAAGic,EAAaC,KAInD9e,KAAKsa,eACFlZ,UAAU,QACV+F,KAAK4X,GACLtB,QACApb,OAAO,QACPtB,KAAK,QAAS,SACdA,KAAK,kBAAoB6B,GAAMA,EAAEuE,KAAKuB,KACtC3H,KAAK,cAAe,SACpBA,KAAK,aAAe6B,GAAMA,EAAEkI,OAC5B/J,KAAK,aAAe6B,GAAMA,EAAEkI,MAAQ9K,KAAKyR,YACzC5P,MACC,YACCe,GAAM8H,EAAsBC,UAAU3K,KAAK4K,UAAWhI,GAAK,MAE7D7B,KAAK,cAAe,UACpBc,MAAM,OAASe,GACd8H,EAAsBsB,UAAUpJ,EAAElB,OAAOC,MAAO,EAAG,IAAK,KAEzDZ,KACC,YACC6B,GACMA,EAAEpB,SAASwO,KACT,aAAa,CAClBpN,EAAEpB,QAAQwO,KAAKhN,EACfJ,EAAEpB,QAAQwO,KAAK/M,EACbyH,EAAsBkF,qBAAqB5P,KAAM4C,OAJxB,kBAQhC+M,KAAM/M,GAAM8H,EAAsBiB,UAAU/I,EAAEuE,KAAKuB,MACnD3H,KAAK,UAAY6B,GAChBA,EAAEkI,MAAQ9K,KAAKyR,YAAc6G,EAAa,EAAI,EAGtD,CAEA,kBAAAgG,GACE,MAAM3F,YAAEA,GAAgB3Y,KAAK2M,OACvBqS,EACJhf,KAAK4X,SAAS7U,OAAQH,GAAkB,IAAZA,EAAE4J,OAAa1K,OAAS,EAAI,EAAI,EAE9D9B,KAAKua,mBACFnZ,UAAU,QACV+F,KAAKnH,KAAK4X,SAAS7U,OAAQH,GAAMA,EAAE4J,QAAUwS,IAC7CvB,QACApb,OAAO,QACPtB,KAAK,QAAU6B,GAAM,wBAAwBA,EAAEiZ,MAC/C9a,KAAK,cAAe,UACpBc,MACC,YACCe,GAA2D,GAArD8H,EAAsBC,UAAU3K,KAAK4K,UAAWhI,GAAW,MAEnE7B,KACC,YACC6B,GACMA,EAAEpB,SAASwO,KACT,aAAa,CAClBpN,EAAEpB,QAAQwO,KAAKhN,EACfJ,EAAEpB,QAAQwO,KAAK/M,EAEX,EADFyH,EAAsBC,UAAU3K,KAAK4K,UAAWhI,IAE7C8H,EAAsBiB,UAAU/I,EAAEuE,KAAKuB,KAAK,GAAM,GAAK,SANjC,kBAUhC4C,KAAM1I,GAAM,IAAMzD,EAAGwS,OAAO,MAAVxS,CAAiByD,EAAEkI,MAAQ9K,KAAKyR,aAClD1Q,KAAK,UAAY6B,GAChB+V,GACI7U,KAAK3D,MAAOyC,EAAEkI,MAAQ9K,KAAKyR,WAAc,KAAO,EAC9C,EAEF,EAEV,CAEA,iBAAA8M,GACE,MAAM3F,WAAEA,EAAUN,WAAEA,GAAetY,KAAK2M,OAExC3M,KAAKoa,YACFhZ,UAAU,QACV+F,KAAKnH,KAAK4X,SAAS7U,OAAQH,GAAkB,IAAZA,EAAE4J,QACnCiR,QACApb,OAAO,QACPtB,KAAK,QAAU6B,GAAM,gBAAgBA,EAAEiZ,MACvC9a,KAAK,eAAiB6B,GAAMA,EAAEuE,KAAKuB,KACnC3H,KAAK,aAAe6B,GAAMA,EAAEkI,OAC5B/J,KAAK,aAAe6B,GAAMA,EAAEkI,MAAQ9K,KAAKyR,YACzC1Q,KAAK,cAAe,SACpBc,MACC,YACCe,GAAM8H,EAAsBU,WAAWpL,KAAK4K,UAAWhI,GAAK,MAE9Df,MAAM,OAASe,GACd8H,EAAsBkB,YAAYhJ,EAAEjB,MAAO,GAAG,IAAM,KAErDZ,KAAK,YAAc6B,GACbA,EAAEpB,SAASwO,KACT4I,EACH,aAAa,CACXhW,EAAEpB,QAAQwO,KAAKhN,EACfJ,EAAEpB,QAAQwO,KAAK/M,EAMX,EALFyH,EAAsBQ,WACpBlL,KAAK4K,UACLhI,EAAEuE,KAAKA,KAAKqE,gBACZ5I,EAAElB,OAAOoJ,QAGRJ,EAAsBiB,UACrB/I,EAAEuE,KAAKA,KAAKqE,iBACZ,GACA,GACA,QAER,aAAad,EAAsBqF,YAAY/P,KAAM4C,MAjB5B,kBAmB9B+M,KAAM/M,GAAM8H,EAAsBiB,UAAU/I,EAAEuE,KAAKuB,MACnD3H,KAAK,UAAY6B,GAAOA,EAAEkI,MAAQ9K,KAAKyR,WAAa6G,EAAa,EAAI,EAC1E,CAEA,cAAAkG,GACE,MAAMnG,UAAEA,GAAcrY,KAAK2M,OAE3B3M,KAAKqa,eACFjZ,UAAU,QACV+F,KAAKnH,KAAK4X,SAAS7U,OAAQH,GAAkB,IAAZA,EAAE4J,QACnCiR,QACApb,OAAO,QACPtB,KAAK,QAAU6B,GAAM,gBAAgBA,EAAEiZ,MACvC9a,KAAK,cAAe,UACpBc,MACC,YACCe,GAA4D,GAAtD8H,EAAsBU,WAAWpL,KAAK4K,UAAWhI,GAAW,MAEpE7B,KACC,WACC6B,GAAMA,EAAEuE,KAAKA,KAAKoE,cAAgB3I,EAAEuE,KAAKA,KAAKqE,iBAEhDzK,KACC,YACC6B,GACMA,EAAEpB,SAASwO,KACT,aAAa,CAClBpN,EAAEpB,QAAQwO,KAAKhN,EACfJ,EAAEpB,QAAQwO,KAAK/M,EAAIyH,EAAsBW,aAAarL,KAAM4C,OAHjC,kBAOhC0I,KAAM1I,GAAM8H,EAAsBuH,UAAUrP,EAAEuE,KAAKoD,OAAO,GAAG5D,OAC7D5F,KAAK,UAAY6B,GAAOA,EAAEkI,MAAQuN,EAAY,EAAI,EACvD,CAIA,iBAAA0B,GACE,MAAMrB,WAAEA,EAAUK,YAAEA,EAAWC,YAAEA,GAAgBhZ,KAAK2M,OAElD+L,GACF1Y,KAAKqZ,cAAcxT,OAAO7F,KAAKuI,IAAI7H,OAAQ,CAAEqF,gBAAiB,IAGhE/F,KAAKoZ,eAAenZ,OAClBD,KAAKuI,IAAI7H,OACTqY,EACAC,EACAtO,EAAsBqB,SAASkT,KAAKvU,GAExC,wJDtqBK,WACL,MAAO,05BA8CT,2CE3Ke,SAA0BiT,EAAS7X,EAAU,IAC1D,MAAM6L,OACJA,EAAS,SAAQuN,QACjBA,EAAU,gBAAexI,UACzBA,EAAY,0BAAyByI,QACrCA,EAAU,MACRrZ,EAGEsQ,EAAgBC,SAAS+I,eAAeF,GAI9C,GAHI9I,GAAeA,EAAcxV,UAG5B+c,IAAYA,EAAQE,UAEvB,YADIsB,GAASA,KAIf,MAAME,EAAc1B,EAAQE,UAAUnd,OAChC4e,EAAaD,EAAYE,gBAC/B,IAAKD,EAAY,OAIjB,MAAME,EAAWH,EAAY5Y,UAGvBgZ,EAAaD,EAASxc,EAAIwc,EAASpf,MAAQ,EAC3Csf,EAAaF,EAASvc,EAAIuc,EAASnZ,OAAS,EAI5CsZ,EAAWL,EAAWM,iBAC5BD,EAAS3c,EAAIyc,EACbE,EAAS1c,EAAIyc,EACb,MAAMG,EAAcF,EAASG,gBAAgBR,EAAWS,gBAGlD/c,EAAI6c,EAAY7c,EAAIgd,OAAOC,QAC3Bhd,EAAI4c,EAAY5c,EAAI+c,OAAOE,QAG3BC,EAAaN,EAAY5c,EACzBmd,EAAaJ,OAAOK,YAAcR,EAAY5c,EAC9Cqd,EAAaH,EAAa,KAAOC,EAAaD,EAG9ChZ,EAAO,CACXuB,IAAKiV,EAAQjV,OACTiV,EAAQxW,MAAQ,MAChBwW,EAAQxW,MAAMA,MAAQ,MACtBwW,EAAQ/a,GAAGuE,MAAMA,MAAQ,CAAA,GAG/B,IAAI4P,EAAUpF,EACXjP,QAAQ,aAAc,CAACmE,EAAO0Z,KAC7B,MAAMC,EAAMrZ,EAAKoZ,GACjB,OAAOC,QAAoCxX,OAAOwX,GAAO3Z,IAE1DnE,QAAQ,OAAQ,QAChBA,QAAQ,MAAO,QAGlB,MAAM8T,EAAQH,SAASI,cAAc,OACrCD,EAAMqF,GAAKqD,EACX1I,EAAME,UAAYA,EAElBtX,OAAOC,OAAOmX,EAAM3U,MAAO,CACzB4e,SAAU,WACV5J,KAAM,UACNC,IAAK,MACL4J,OAAQ,SAEVlK,EAAMmK,UAAUC,IAAIN,EAAa,cAAgB,eAEjD9J,EAAMQ,UAAY,+EACqBD,oBAIvCV,SAASa,KAAKD,YAAYT,GAG1B,MAAMqK,EAAarK,EAAMsK,YACnBC,EAAcvK,EAAMwK,aAG1B,IAAIC,EAASje,EAAI6d,EAAa,EAI1BI,EAHY,GAIdA,EAJc,GAKLA,EAASJ,EAAab,OAAOkB,WALxB,KAMdD,EAASjB,OAAOkB,WAAaL,EANf,IAUhB,MAAMM,EAASb,EAAard,EAAI,EAAIA,EAAI,EAAI8d,EAG5CvK,EAAM3U,MAAMgV,KAAO,GAAGoK,MACtBzK,EAAM3U,MAAMiV,IAAM,GAAGqK,MAGrB,MAAMC,EAAW1S,IACf,IAAK8H,EAAMY,SAAS1I,EAAE2I,UAAYiI,EAAWlI,SAAS1I,EAAE2I,QAAS,CAC/Db,EAAM5V,SACNyV,SAASiB,oBAAoB,QAAS8J,GACtC/K,SAASiB,oBAAoB,aAAc8J,GAC3C,MAAMC,EAAc/B,EAAWhJ,cAAc,gBACzC+K,GAAaA,EAAYV,UAAU/f,OAAO,WAC1Cue,GAASA,GACf,GAOF,OALA7W,WAAW,KACT+N,SAASkB,iBAAiB,QAAS6J,GACnC/K,SAASkB,iBAAiB,aAAc6J,IACvC,IAEI5K,CACT,2BFnHO,SAA0BL,GAC/B,IAAKA,EAAa,OAAO,KAEzB,MAAMhP,EAAOgP,EAAYhP,MAAQ,CAAA,EAIjC,MAAoB,oBAATwI,KACFA,IAAI;;;;;;;;;UASLxI,EAAKqE,iBAAmB;;;mCAGCrE,EAAKwC,QAAU;;;iCAGjBxC,EAAKyC,YAAc;;YAM3CsM,EAAeC,EACxB"}